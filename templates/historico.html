<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Histórico de Folgas</title>

  <!-- Assets -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f3f4f6;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#0d6efd;
      --brand-soft:#e0edff;
      --border-soft:#e5e7eb;
      --card-shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 4px rgba(15,23,42,.05);
      --radius:18px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--ink);
      font-family:'Montserrat',sans-serif;
      display:flex;
      flex-direction:column;
    }

    main.shell{
      flex:1 0 auto;
      max-width:1100px;
      margin:0 auto;
      padding:24px 16px 80px;
    }

    @media (min-width:769px){
      main.shell{
        padding:30px 24px 90px;
      }
    }

    /* ========= CABEÇALHO PADRÃO ========= */

    .header-desktop,
    .header-mobile{
      display:none;
      flex-shrink:0;
    }

    /* Desktop */
    @media (min-width:769px){
      .header-desktop{
        display:flex;
        background-color:#007bff;
        padding:15px 30px;
        width:100%;
        align-items:center;
        justify-content:space-between;
        box-sizing:border-box;
        min-height:110px;
        position:relative;
        box-shadow:0 2px 6px rgba(0,0,0,0.15);
        color:white;
      }

      .left-section{
        display:flex;
        align-items:center;
        gap:20px;
      }

      .logo{
        width:80px;
        height:80px;
        object-fit:contain;
        border-radius:10px;
        background-color:white;
        padding:6px;
      }

      .text-container{
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:left;
        color:white;
      }

      .escola-nome{
        font-weight:700;
        font-size:1.6rem;
        margin:0;
        line-height:1.1;
      }

      .escola-subtitulo{
        font-weight:600;
        font-size:1.1rem;
        margin-top:4px;
      }

      .header-center-text-container{
        position:absolute;
        left:50%;
        top:50%;
        transform:translate(-50%,-50%);
        display:flex;
        align-items:center;
        gap:20px;
        user-select:none;
        z-index:1;
      }

      .header-center-text{
        font-weight:800;
        font-size:1.9rem;
        color:white;
        letter-spacing:5px;
        white-space:nowrap;
        text-shadow:0 2px 5px rgba(0,0,0,0.3);
      }

      .btn-home{
        background-color:#0fb300;
        color:white;
        padding:6px 14px;
        border-radius:6px;
        font-weight:700;
        font-size:1.5rem;
        text-decoration:none;
        display:flex;
        align-items:center;
        gap:8px;
        box-shadow:0 2px 6px rgba(15,179,0,0.8);
        transition:background-color 0.3s ease;
        position:absolute;
        right:30px;
        top:50%;
        transform:translateY(-50%);
        z-index:2;
      }

      .btn-home:hover{
        background-color:#0d8a00;
      }
    }

    /* Mobile */
    @media (max-width:768px){
      .header-mobile{
        display:block;
        width:100%;
        box-sizing:border-box;
        color:white;
        position:sticky;
        top:0;
        z-index:1000;
        box-shadow:0 2px 6px rgba(0,0,0,0.15);
        background-color:#007bff;
      }

      .header-top{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:15px;
        padding:10px 15px;
        background-color:#007bff;
        text-align:center;
      }

      .logo{
        width:48px;
        height:48px;
        object-fit:contain;
        border-radius:10px;
        background-color:white;
        padding:6px;
      }

      .text-container{
        display:flex;
        flex-direction:column;
        justify-content:center;
        color:white;
        text-align:center;
      }

      .escola-nome{
        font-weight:700;
        font-size:1.3rem;
        margin:0;
        line-height:1.1;
      }

      .escola-subtitulo{
        font-weight:600;
        font-size:1rem;
        margin-top:2px;
      }

      .header-bottom{
        background-color:#0056b3;
        text-align:center;
        padding:12px 10px;
        font-weight:800;
        font-size:1.0rem;
        letter-spacing:4px;
        user-select:none;
        color:white;
        box-shadow:inset 0 -2px 5px rgba(0,0,0,0.2);
        display:flex;
        justify-content:center;
        align-items:center;
        gap:12px;
        white-space:nowrap;
      }

      .btn-home-mobile{
        background-color:#0fb300;
        color:white;
        padding:6px 10px;
        border-radius:6px;
        font-weight:600;
        font-size:1rem;
        text-decoration:none;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 2px 6px rgba(15,179,0,0.8);
        transition:background-color 0.3s ease;
      }

      .btn-home-mobile:hover{
        background-color:#0d8a00;
      }
    }

    /* ========= HEADER DA PÁGINA ========= */

    .page-header-card{
      background:#ffffff;
      border-radius:var(--radius);
      padding:16px 18px;
      margin-bottom:18px;
      display:flex;
      align-items:center;
      gap:16px;
      box-shadow:0 10px 28px rgba(15,23,42,0.12);
      border-left:5px solid var(--brand);
    }

    .page-header-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:42px;
      height:42px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #ffffff 0%, var(--brand-soft) 60%, #c7d9ff 100%);
      box-shadow:0 4px 12px rgba(37, 99, 235, 0.45);
      color:#2563eb;
      flex-shrink:0;
    }

    .page-header-icon i{
      font-size:22px;
    }

    .page-header-content{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .page-header-title{
      font-size:1.2rem;
      font-weight:800;
      margin:0;
      color:var(--ink);
    }

    .page-header-subtitle{
      font-size:0.9rem;
      margin:0;
      color:var(--muted);
    }

    @media (max-width:600px){
      .page-header-card{
        padding:12px 14px;
        margin-bottom:14px;
      }
      .page-header-title{
        font-size:1.05rem;
      }
      .page-header-subtitle{
        font-size:0.82rem;
      }
    }

    /* ========= FLASH ========= */

    .flash-wrap{
      max-width:900px;
      margin:0 auto 14px auto;
    }

    .flash-success{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:#e8f7ee;
      color:#065f46;
      border:1px solid #b7ebc6;
      padding:12px 14px;
      border-radius:12px;
      font-weight:700;
      box-shadow:0 3px 10px rgba(6,95,70,0.08);
    }

    .flash-success i{
      color:#10b981;
    }

    /* ========= GRID PRINCIPAL ========= */

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
    }

    @media (min-width:992px){
      .grid{
        grid-template-columns:1fr 1fr;
      }
      .grid .span-2{
        grid-column:span 2;
      }
    }

    /* ========= CARDS ========= */

    .card{
      background:#ffffff;
      border-radius:var(--radius);
      border:1px solid var(--border-soft);
      box-shadow:var(--card-shadow);
      overflow:hidden;
    }

    .card-head{
      background:linear-gradient(135deg,#0d6efd 0%,#0b5ed7 55%,#0a58ca 100%);
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .card-head h3{
      margin:0;
      font-weight:900;
      font-size:1.05rem;
      letter-spacing:.5px;
      color:#fff;
      text-shadow:0 2px 6px rgba(0,0,0,.35);
    }

    .card-head i{
      color:#fff;
      opacity:.95;
    }

    .card-body{
      padding:18px;
    }

    /* ========= RESUMO ========= */

    .info-rows{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .info-row{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      width:100%;
      font-weight:800;
      font-size:0.9rem;
    }

    .info-row .label{
      opacity:.95;
    }

    .row-green{
      background:#e8f7ee;
      color:#065f46;
      border:1px solid #b7ebc6;
    }

    .row-blue{
      background:#eaf2ff;
      color:#1e40af;
      border:1px solid #c7dcff;
    }

    .row-gray{
      background:#eef2f7;
      color:#111827;
      border:1px solid #e2e8f0;
    }

    /* ========= CHIPS ========= */

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:.45rem .7rem;
      border-radius:999px;
      font-weight:800;
      font-size:.9rem;
      background:#f3f4f6;
      color:#111827;
      border:1px solid #e5e7eb;
      text-decoration:none;
    }

    .chip i{
      font-size:0.9rem;
    }

    .chip.yellow{
      background:#fff7ed;
      color:#92400e;
      border-color:#fed7aa;
    }

    .chip.teal{
      background:#e6fffa;
      color:#0f766e;
      border-color:#b2f5ea;
    }

    .chip:hover{
      text-decoration:none;
      filter:brightness(0.97);
    }

    /* ========= TABELAS ========= */

    table{
      width:100%;
      border-collapse:collapse;
    }

    thead th{
      background:#f8fafc;
      color:#0f172a;
      font-weight:900;
      text-align:center;
      padding:10px;
      white-space:nowrap;
      border-bottom:1px solid #edf2f7;
      font-size:0.85rem;
    }

    tbody td{
      text-align:center;
      padding:10px;
      border-bottom:1px solid #f1f5f9;
      font-size:0.87rem;
    }

    tbody tr:hover{
      background:#f7fbff;
    }

    .badge-status{
      font-weight:800;
      padding:.4rem .6rem;
      border-radius:999px;
      font-size:0.8rem;
    }

    .status-pendente{
      background:#fff3cd;
      color:#856404;
    }

    .status-deferida{
      background:#d1fae5;
      color:#065f46;
    }

    .status-indeferida{
      background:#fee2e2;
      color:#991b1b;
    }

    .empty{
      margin-top:6px;
      background:#f8fafc;
      border:1px dashed #d1d5db;
      color:#6b7280;
      border-radius:12px;
      padding:12px 14px;
      text-align:center;
      font-weight:700;
      font-size:0.9rem;
    }

    .table-responsive{
      width:100%;
      overflow-x:auto;
    }

    /* ========= RODAPÉ ========= */

    footer{
      background:linear-gradient(to right,#222,#444);
      color:#ddd;
      text-align:center;
      padding:15px 0;
      font-size:14px;
      border-top:2px solid #555;
      box-shadow:0 -2px 10px rgba(0,0,0,.3);
      width:100%;
      flex-shrink:0;
    }

    footer p{
      margin:5px 0;
      font-size:0.9rem;
    }

    footer a{
      color:#fff;
      text-decoration:none;
      font-weight:500;
    }

    footer a:hover{
      color:#00aaff;
    }

    @media (max-width:768px){
      main.shell{
        padding:16px 12px 70px;
      }
      .card-body{
        padding:14px;
      }
      .info-row{
        font-size:0.85rem;
      }
    }
  </style>
</head>
<body>

  <!-- Header Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>

    <div class="header-center-text-container">
      <div class="header-center-text">PORTAL DO SERVIDOR</div>
    </div>

    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Header Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <main class="shell">

    <!-- Cabeçalho da página -->
    <div class="page-header-card">
      <div class="page-header-icon">
        <i class="fas fa-calendar-check"></i>
      </div>
      <div class="page-header-content">
        <p class="page-header-title">Histórico de Folgas</p>
        <p class="page-header-subtitle">
          Acompanhe suas folgas, TREs enviadas e o resumo geral de utilização ao longo do ano.
        </p>
      </div>
    </div>

    <!-- Flash -->
    <div class="flash-wrap">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash-success">
              <i class="fas fa-check-circle"></i> {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {# ==========================================================
       PRÉ-CÁLCULOS (se precisar reaproveitar em outros pontos)
       ========================================================== #}
    {% set tre_list = (tres if (tres is defined and tres) else (minhas_tres if (minhas_tres is defined and minhas_tres) else [])) %}
    {% set deferidos_sum = 0 %}
    {% set pendentes_sum = 0 %}
    {% for t in tre_list %}
      {% set st = (t.status or '')|lower|trim %}
      {% if st == 'deferida' %}
        {% set deferidos_sum = deferidos_sum + ((t.dias_validados if t.dias_validados is not none else t.dias_folga) or 0) %}
      {% elif st == 'pendente' %}
        {% set pendentes_sum = pendentes_sum + (t.dias_folga or 0) %}
      {% endif %}
    {% endfor %}
    {% set restantes_disp = (tre_restantes if tre_restantes is defined else (current_user.tre_total or 0)) %}
    {% if restantes_disp < 0 %}{% set restantes_disp = 0 %}{% endif %}
    {% set total_geral = restantes_disp + deferidos_sum %}

    <!-- GRID PRINCIPAL -->
    <section class="grid">

      <!-- Resumo -->
      <div class="card">
        <div class="card-head">
          <i class="fas fa-gauge-high"></i>
          <h3>Resumo</h3>
        </div>
        <div class="card-body">
          <div class="info-rows">

            <div class="info-row row-green">
              <i class="fas fa-calendar-check"></i>
              <div class="label">
                Abonadas: <strong>{{ saldo_abonadas }}</strong> de {{ limite_abonadas_ano }} no ano
              </div>
            </div>

            <div class="info-row row-blue">
              <i class="fas fa-medal"></i>
              <div class="label">
                {% set _total  = (tre_total if tre_total is defined else (current_user.tre_total or 0))|int %}
                {% set _usadas = (tre_usufruidas if tre_usufruidas is defined else (current_user.tre_usufruidas or 0))|int %}
                {% set _rest   = _total - _usadas %}
                {% if _rest < 0 %}{% set _rest = 0 %}{% endif %}

                TREs: <strong>{{ _usadas }}</strong> usufruída(s) •
                <strong>{{ _rest }}</strong> restante(s) de <strong>{{ _total }}</strong>
              </div>
            </div>

            <div class="info-row row-gray">
              <i class="fas fa-clock"></i>
              <div class="label">
                {% if banco_horas_formatado is defined %}
                  Banco de horas: <strong>{{ banco_horas_formatado }}</strong>
                {% else %}
                  {% set horas = (current_user.banco_horas or 0) // 60 %}
                  {% set minutos = (current_user.banco_horas or 0) % 60 %}
                  Banco de horas: <strong>{{ horas }}h {{ '%02d' % minutos }}min</strong>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Últimas Folgas (até 3) -->
      <div class="card">
        <div class="card-head">
          <i class="fas fa-list"></i>
          <h3>Últimas Folgas</h3>
        </div>
        <div class="card-body">
          {% if ultimas_folgas %}
            {% set folgas_ordenadas = ultimas_folgas|sort(attribute='data', reverse=True) %}
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Motivo</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for f in folgas_ordenadas %}
                    {% if loop.index0 < 3 %}
                      <tr>
                        <td>{{ f.data.strftime('%d/%m/%Y') }}</td>
                        <td>{{ f.motivo }}</td>
                        <td>{{ f.status|title }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty">Nenhuma folga recente.</div>
          {% endif %}
        </div>
      </div>

      <!-- Minhas TREs -->
      <div class="card span-2">
        <div class="card-head">
          <i class="fas fa-file-upload"></i>
          <h3>Minhas TREs</h3>
        </div>
        <div class="card-body">

          {# Normaliza lista de TREs: aceita 'tres' ou 'minhas_tres' #}
          {% set tre_list = (tres if (tres is defined and tres) else (minhas_tres if (minhas_tres is defined and minhas_tres) else [])) %}

          {# Dias deferidos = vindo do usuário/rota #}
          {% set deferidos_dias = (tre_total if tre_total is defined else (current_user.tre_total or 0))|int %}

          {# Dias pendentes: soma dos dias_folga com status 'pendente' #}
          {% set acc = namespace(pendentes=0) %}
          {% for t in tre_list %}
            {% if (t.status or '')|lower|trim == 'pendente' %}
              {% set acc.pendentes = acc.pendentes + (t.dias_folga or 0) %}
            {% endif %}
          {% endfor %}

          <div class="chips" style="margin-bottom:12px">
            <span class="chip teal">
              <i class="fas fa-sun"></i> Dias deferidos: <strong>{{ deferidos_dias }}</strong>
            </span>
            <span class="chip yellow">
              <i class="fas fa-hourglass-half"></i> Dias pendentes: <strong>{{ acc.pendentes }}</strong>
            </span>
          </div>

          {% set tre_sorted = tre_list|sort(attribute='id', reverse=True) %}
          {% if tre_sorted|length > 0 %}
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Dias (solicit.)</th>
                    <th>Status</th>
                    <th>Enviado em</th>
                    <th>Arquivo</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in tre_sorted %}
                    <tr>
                      <td>
                        {{ t.dias_folga }}
                        {% if t.dias_validados %}
                          <div class="text-muted" style="font-size:.85rem">
                            val.: {{ t.dias_validados }} dia(s)
                          </div>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge-status
                          {% if (t.status or '')|lower|trim == 'pendente' %}status-pendente
                          {% elif (t.status or '')|lower|trim == 'deferida' %}status-deferida
                          {% else %}status-indeferida{% endif %}">
                          {{ (t.status or '')|title }}
                        </span>
                        {% if t.parecer_admin %}
                          <div class="text-muted" style="font-size:.85rem">
                            parecer: {{ t.parecer_admin }}
                          </div>
                        {% endif %}
                      </td>
                      <td>{{ t.data_envio.strftime('%d/%m/%Y %H:%M') if t.data_envio else '-' }}</td>
                      <td>
                        <a class="chip" href="{{ url_for('download_tre', tre_id=t.id) }}">
                          <i class="fas fa-download"></i> PDF
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty">Você ainda não enviou TREs.</div>
          {% endif %}
        </div>
      </div>

    </section>
  </main>

  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <script>
    // some feedback: esmaecer mensagens de sucesso depois de alguns segundos
    setTimeout(() => {
      document.querySelectorAll('.flash-success').forEach(el => {
        el.style.transition = 'opacity 0.8s ease';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 800);
      });
    }, 8000);
  </script>
</body>
</html>
