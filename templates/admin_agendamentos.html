<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendamentos - Administração</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS global do projeto -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <!-- CSRF: disponibiliza o token para requisições JS -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #0051ff;
      --primary-soft: #e0edff;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --danger: #dc2626;
      --danger-soft: #fee2e2;
      --warning-soft: #fef9c3;
      --card-shadow: 0 14px 34px rgba(15,23,42,.1), 0 2px 4px rgba(15,23,42,.06);
      --radius: 18px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at top, #e0f2ff 0, #f9fafb 45%, #eef2ff 100%);
      background-attachment: fixed;
      color: var(--text-main);
    }

    body { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1 0 auto; padding: 24px 12px 60px; box-sizing: border-box; }
    .shell { width: 100%; max-width: 1100px; margin: 0 auto; }
    @media (min-width: 769px) { main { padding: 30px 24px 80px; } }

    /* ===== Cabeçalhos ===== */
    .header-desktop, .header-mobile { display: none; flex-shrink: 0; }

    /* Desktop */
    @media (min-width: 769px) {
      .header-desktop {
        display: flex;
        background-color: #007bff;
        padding: 15px 30px;
        width: 100%;
        align-items: center;
        justify-content: space-between;
        min-height: 110px;
        position: relative;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        color: white;
      }
      .left-section { display: flex; align-items: center; gap: 20px; }
      .logo { width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background-color: white; padding: 6px; }
      .text-container { display: flex; flex-direction: column; color: white; }
      .escola-nome { font-weight: 700; font-size: 1.6rem; margin: 0; line-height: 1.1; }
      .escola-subtitulo { font-weight: 600; font-size: 1.1rem; margin-top: 4px; }
      .header-center-text-container {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
        font-weight: 800; font-size: 1.9rem; color: white; letter-spacing: 5px;
        user-select: none; white-space: nowrap; z-index: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      .header-center-text { font-family: 'Montserrat', sans-serif; }
      .btn-home {
        background-color: #0fb300; color: white; padding: 6px 14px; border-radius: 6px;
        font-weight: 700; font-size: 1.5rem; text-decoration: none; display: flex; align-items: center; gap: 8px;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8); transition: background-color 0.3s ease;
        position: absolute; right: 30px; top: 50%; transform: translateY(-50%); z-index: 2;
      }
      .btn-home:hover { background-color: #0d8a00; }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .header-mobile {
        display: block; width: 100%; color: white; position: sticky; top: 0; z-index: 1000;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); background-color: #007bff;
      }
      .header-top { display: flex; align-items: center; justify-content: center; gap: 15px; padding: 10px 15px; background-color: #007bff; }
      .logo { width: 48px; height: 48px; object-fit: contain; border-radius: 10px; background-color: white; padding: 6px; }
      .text-container { display: flex; flex-direction: column; color: white; text-align: center; }
      .escola-nome { font-weight: 700; font-size: 1.3rem; margin: 0; line-height: 1.1; }
      .escola-subtitulo { font-weight: 600; font-size: 1rem; margin-top: 2px; }
      .header-bottom {
        background-color: #0056b3; text-align: center; padding: 12px 10px; font-weight: 800; font-size: 1rem;
        letter-spacing: 4px; color: white; display: flex; justify-content: center; align-items: center; gap: 12px; white-space: nowrap;
      }
      .btn-home-mobile {
        background-color: #0fb300; color: white; padding: 6px 10px; border-radius: 6px; font-weight: 600; font-size: 1rem;
        text-decoration: none; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8); transition: background-color 0.3s ease;
      }
      .btn-home-mobile:hover { background-color: #0d8a00; }
    }

    /* ===== HEADER CARD DA PÁGINA ===== */
    .page-header-card {
      background: #ffffff; border-radius: var(--radius); padding: 16px 18px; margin: 0 auto 18px;
      display: flex; align-items: center; gap: 16px; box-shadow: var(--card-shadow); border-left: 5px solid var(--primary);
    }
    .page-header-icon {
      display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, #e0edff 60%, #c7d9ff 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, .45); color: #2563eb; flex-shrink: 0;
    }
    .page-header-icon i { font-size: 22px; }
    .page-header-content { display: flex; flex-direction: column; gap: 4px; }
    .page-header-title { font-size: 1.15rem; font-weight: 800; margin: 0; color: var(--text-main); }
    .page-header-subtitle { font-size: 0.9rem; margin: 0; color: var(--text-muted); }
    @media (max-width: 600px) { .page-header-card{padding:12px 14px}.page-header-title{font-size:1.05rem}.page-header-subtitle{font-size:.82rem} }

    /* ===== CARD BASE ===== */
    .content-card {
      width: 100%; margin: 0 auto 24px; background: var(--surface);
      border-radius: 16px; box-shadow: var(--card-shadow); padding: 18px 18px 20px;
      border: 1px solid rgba(148, 163, 184, 0.35); backdrop-filter: blur(8px); box-sizing: border-box;
    }
    .content-title { font-size: 1.05rem; font-weight: 700; margin: 0 0 6px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
    .content-title i { color: var(--primary); }
    .content-subtitle { font-size: 0.88rem; color: var(--text-muted); margin: 0 0 14px; }
    .filter-card { margin-bottom: 22px; }

    /* Alertas */
    .alert-wrapper { margin: 0 auto 14px; max-width: 1100px; }
    .alert { margin: 0; padding: 10px 14px; border-radius: 10px; font-size: 0.88rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .alert-success { background: var(--success-soft); color: #166534; border: 1px solid #bbf7d0; }
    .alert-error { background: var(--danger-soft); color: #b91c1c; border: 1px solid #fecaca; }
    .alert i { font-size: 0.95rem; }

    /* ===== FILTROS ===== */
    .filters { margin-top: 8px; }
    .filter-form { display: grid; grid-template-columns: minmax(220px, 1.5fr) minmax(160px, 1fr) minmax(180px, 1.2fr) auto; gap: 10px; align-items: end; }
    @media (max-width: 860px) { .filter-form { grid-template-columns: 1fr; } }
    .filter-label { font-size: .78rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: .08em; margin-bottom: 4px; }
    .filter-form input, .filter-form select {
      width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border-soft); font-size: 0.9rem; outline: none; transition: border-color .15s ease, box-shadow .15s ease;
    }
    .filter-form input:focus, .filter-form select:focus { border-color: var(--primary); box-shadow: 0 0 0 1px rgba(59,130,246,.55); }
    .btn-clear {
      padding: 9px 14px; border-radius: 999px; cursor: pointer; font-size: 0.86rem; background: #6b7280; color: white;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 6px; border: none;
      box-shadow: 0 4px 12px rgba(31,41,55,.35); transition: background-color .18s ease, transform .12s ease, box-shadow .18s ease; white-space: nowrap;
    }
    .btn-clear:hover { background: #4b5563; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(31,41,55,.45); }
    .btn-clear i { font-size: 0.85rem; }

    /* Resultados */
    #resultadoAgendamentos { margin-top: 10px; }
    .loading { text-align: center; color: var(--text-muted); padding: 18px 4px 6px; font-size: 0.9rem; }

    /* Cards de funcionário */
    .employee-card { margin-bottom: 14px; border-radius: 14px; background: #ffffff; border: 1px solid var(--border-soft); box-shadow: 0 10px 24px rgba(15,23,42,.12); overflow: hidden; }
    .employee-header {
      width: 100%; padding: 10px 14px; background: linear-gradient(90deg,#f9fafb 0,#eef2ff 100%);
      border: none; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
      font-weight: 700; font-size: 0.95rem; color: #0f172a;
    }
    .employee-header-left { display: flex; align-items: center; gap: 10px; }
    .employee-avatar { width: 30px; height: 30px; border-radius: 999px; background: radial-gradient(circle at 30% 30%, #eff6ff 0, #bfdbfe 60%, #93c5fd 100%); display: flex; align-items: center; justify-content: center; color: #1d4ed8; font-size: 0.9rem; }
    .employee-name { margin: 0; }
    .employee-header-right { display: flex; align-items: center; gap: 10px; font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .employee-header-right i { transition: transform 0.25s ease; font-size: 0.85rem; color: #64748b; }
    .employee-header.open i { transform: rotate(180deg); }

    .employee-details { display: none; padding: 10px 12px 12px; background: #f9fafb; }

    .employee-table-wrapper { overflow-x: auto; border-radius: 10px; background: #ffffff; box-shadow: inset 0 0 0 1px #e5e7eb; }

    /* ===== TABELA ===== */
    .employee-table { width: 100%; border-collapse: collapse; min-width: 720px; }

    /* CENTRALIZA TODO O CONTEÚDO */
    .employee-table th,
    .employee-table td {
      padding: 8px 10px;
      font-size: 0.86rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
    }

    .employee-table th {
      background: #f3f4f6;
      font-weight: 700;
      color: #111827;
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: 0.06em;
    }

    .employee-table tbody tr:nth-child(even) { background: #f9fafb; }

    /* ✅ GARANTE ESPAÇO SUFICIENTE PRA A COLUNA AÇÕES (EVITA QUEBRAR EM 2 LINHAS) */
    .employee-table td:last-child,
    .employee-table th:last-child {
      min-width: 280px;
    }

    /* Status */
    .status-deferido, .status-em-espera, .status-indeferido {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px;
      font-weight: 700; font-size: 0.78rem; white-space: nowrap; border: 1px solid transparent;
    }
    .status-deferido { background: var(--success-soft); color: #166534; border-color: #bbf7d0; }
    .status-em-espera { background: var(--warning-soft); color: #854d0e; border-color: #facc15; }
    .status-indeferido { background: var(--danger-soft); color: #b91c1c; border-color: #fecaca; }
    .status-deferido i, .status-em-espera i, .status-indeferido i { font-size: 0.85rem; }

    /* Substituição (badge) */
    .sub-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.78rem;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      color: #1d4ed8;
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0 auto;
    }
    .sub-badge.muted {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: #6b7280;
      font-weight: 700;
    }

    /* ✅ AÇÕES: 2 BOTÕES LADO A LADO, MESMO TAMANHO, SEM "HAMBURGUER" */
    .sub-actions {
      display: flex;
      flex-wrap: nowrap;          /* NÃO QUEBRA LINHA */
      gap: 10px;
      width: 100%;                /* ocupa a célula inteira */
      justify-content: center;
      align-items: stretch;
    }

    /* força os dois botões a terem o mesmo tamanho e ignorarem width:100% do CSS global */
    .sub-actions .sub-btn,
    .sub-actions .submit-btn {
      flex: 1 1 0;
      flex-basis: 0;              /* divide igualmente */
      min-width: 0;               /* permite encolher */
      width: 0 !important;        /* se o style.css setar width:100%, isso neutraliza */
    }

    .sub-actions .btn-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      max-width: 100%;
    }

    /* Botão excluir */
    .submit-btn {
      padding: 7px 12px;
      background-color: #ef4444;
      color: #fff;
      border: none;
      font-size: 0.82rem;
      cursor: pointer;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(248,113,113,.35);
      transition: background-color .2s ease, transform .12s ease, box-shadow .18s ease;
      white-space: nowrap;
    }
    .submit-btn i { font-size: 0.85rem; }
    .submit-btn:hover { background-color: #dc2626; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(220,38,38,.45); }

    /* botão de substituição */
    .sub-btn {
      padding: 7px 12px;
      background-color: #2563eb;
      color: #fff;
      border: none;
      font-size: 0.82rem;
      cursor: pointer;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(37,99,235,.28);
      transition: background-color .2s ease, transform .12s ease, box-shadow .18s ease;
      white-space: nowrap;
    }
    .sub-btn i { font-size: 0.85rem; }
    .sub-btn:hover { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37,99,235,.36); }

    /* Ajuste extra pra telas bem estreitas (continua lado a lado) */
    @media (max-width: 420px) {
      .employee-table td:last-child,
      .employee-table th:last-child {
        min-width: 240px;
      }
      .sub-actions { gap: 8px; }
      .sub-btn, .submit-btn { padding: 7px 10px; font-size: 0.78rem; }
    }

    /* Paginação */
    .pagination { text-align: center; margin-top: 16px; font-size: 0.86rem; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .pagination a {
      padding: 6px 12px; border: 1px solid #2563eb; border-radius: 999px; color: #2563eb; text-decoration: none; cursor: pointer;
      transition: background-color .16s ease, color .16s ease;
    }
    .pagination a:hover { background: #2563eb; color: #ffffff; }
    .pagination span { font-weight: 600; color: var(--text-muted); }

    /* ===== Modal de Substituição ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0,0,0,.55);
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    .modal.open { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .modal-header {
      padding: 14px 16px;
      background: linear-gradient(90deg,#f9fafb 0,#eef2ff 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: #64748b;
      font-size: 1.1rem;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .15s ease, color .15s ease;
    }
    .modal-close:hover { background: rgba(100,116,139,.12); color: #0f172a; }

    .modal-body {
      padding: 14px 16px 16px;
      background: #fff;
    }
    .modal-help {
      margin: 0 0 10px;
      color: #6b7280;
      font-size: .86rem;
      line-height: 1.25rem;
    }
    .modal-field {
      display: grid;
      gap: 6px;
      margin-top: 10px;
    }
    .modal-label {
      font-size: .78rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .08em;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: .95rem;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .modal-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,.45);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn-secondary {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #111827;
      font-weight: 800;
      cursor: pointer;
    }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-primary {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      background: #2563eb;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(37,99,235,.25);
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-danger-soft {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 800;
      cursor: pointer;
    }
    .btn-danger-soft:hover { background: #fecaca; }

    /* Footer */
    footer {
      background: linear-gradient(to right, #222, #444); color: #ddd; text-align: center; padding: 15px 0;
      font-size: 14px; border-top: 2px solid #555; box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.3); flex-shrink: 0; width: 100%;
    }
    footer p { margin: 5px 0; font-size: 15px; font-weight: 300; }
    footer a { color: #fff; text-decoration: none; font-weight: 500; transition: color 0.3s ease-in-out; }
    footer a:hover { color: #00aaff; }
  </style>
</head>

<body>

  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-center-text-container">
      <div class="header-center-text">PORTAL DO SERVIDOR</div>
    </div>
    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <main>
    <div class="shell">

      <!-- Header card da página -->
      <div class="page-header-card">
        <div class="page-header-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="page-header-content">
          <p class="page-header-title">Agendamentos</p>
          <p class="page-header-subtitle">
            Visualize, filtre e gerencie os agendamentos registrados pelos servidores da unidade.
          </p>
        </div>
      </div>

      <!-- Alertas dinâmicos (JS) -->
      <div id="alertContainer" class="alert-wrapper"></div>

      <!-- Card de filtros -->
      <div class="content-card filter-card">
        <h2 class="content-title">
          <i class="fas fa-filter"></i>
          Filtros de pesquisa
        </h2>
        <p class="content-subtitle">
          Ajuste os filtros abaixo para localizar rapidamente agendamentos por funcionário, cargo e status.
        </p>

        <div class="filters">
          <form id="filterForm" class="filter-form" onsubmit="return false;">
            <div>
              <div class="filter-label">Funcionário</div>
              <input type="text" name="nome" id="filtroNome" placeholder="Buscar por nome do funcionário...">
            </div>

            <div>
              <div class="filter-label">Status</div>
              <select name="status" id="filtroStatus">
                <option value="">Todos os status</option>
                <option value="deferido">Deferido</option>
                <option value="em_espera">Em espera</option>
                <option value="indeferido">Indeferido</option>
              </select>
            </div>

            <div>
              <div class="filter-label">Cargo</div>
              <select name="cargo" id="filtroCargo">
                <option value="">Todos os cargos</option>
                {% set cargos = [
                  "Agente Administrativo", "Assistente de Direção", "Assistente Tecnico Pedagogico",
                  "Atendente de Educação I", "Atendente de Educação II", "Diretor de Unidade Escolar",
                  "Educador de Desenvolvimento Infanto Juvenil", "Inspetor de Aluno", "Pedagoga Comunitaria",
                  "Professor I", "Professor II", "Professor III", "Professor IV", "Professor Adjunto",
                  "Secretario de Unidade Escolar", "Servente", "Servente I", "Servente II", "Trabalhador"
                ] %}
                {% for c in cargos|sort %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <button id="btnLimpar" class="btn-clear">
                <i class="fas fa-eraser"></i>
                Limpar filtros
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Card principal de resultados -->
      <section class="content-card">
        <h2 class="content-title">
          <i class="fas fa-users-cog"></i>
          Agendamentos por servidor
        </h2>
        <p class="content-subtitle">
          Cada card abaixo representa um servidor e reúne os agendamentos vinculados a ele.
          Clique no cabeçalho para expandir e visualizar os detalhes.
        </p>

        <div id="resultadoAgendamentos" class="loading">
          Carregando agendamentos...
        </div>
      </section>

    </div>
  </main>

  <!-- Modal Substituição (Admin) -->
  <div id="subModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="subModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="subModalTitle">
          <i class="fas fa-user-edit"></i>
          Substituição (Agendamento)
        </h3>
        <button type="button" class="modal-close" aria-label="Fechar" onclick="closeSubModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-help" id="subModalHelp">
          Informe o nome da substituta/substituto. Se deixar em branco, será removido e ficará como “-”.
        </p>

        <div class="modal-field">
          <div class="modal-label">Nome do substituto</div>
          <input id="subNomeInput" class="modal-input" type="text" maxlength="255" placeholder="Ex.: Maria da Silva">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-danger-soft" onclick="clearSubNome()">
            <i class="fas fa-eraser"></i>
            Limpar
          </button>
          <button type="button" class="btn-secondary" onclick="closeSubModal()">
            Cancelar
          </button>
          <button type="button" class="btn-primary" onclick="saveSubNome()">
            <i class="fas fa-save"></i>
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <script>
    function getCSRFToken() {
      const el = document.querySelector('meta[name="csrf-token"]');
      return el ? el.getAttribute('content') : '';
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    let currentController = null;
    let debounceTimer = null;
    let lastSignature = "";
    const DEBOUNCE_MS = 300;

    function showAlert(message, type="success") {
      const alertContainer = document.getElementById("alertContainer");
      const icon = type === "success" ? "check-circle" : "exclamation-triangle";
      alertContainer.innerHTML = `
        <div class="alert ${type === "success" ? "alert-success" : "alert-error"}">
          <i class="fas fa-${icon}"></i>
          <span>${escapeHtml(message)}</span>
        </div>`;
      setTimeout(() => { alertContainer.innerHTML = ""; }, 4000);
    }

    function getFilters() {
      const nome = document.getElementById("filtroNome").value || "";
      const status = document.getElementById("filtroStatus").value || "";
      const cargo = document.getElementById("filtroCargo").value || "";
      return { nome, status, cargo };
    }

    function buildSignature({nome, status, cargo}, page) {
      return `${nome}||${status}||${cargo}||${page}`;
    }

    function parseDateToMillis(str) {
      if (!str) return 0;
      const s = String(str).trim();

      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?/);
      if (m) {
        const [, y, mo, d, hh = '00', mi = '00', ss = '00'] = m;
        return Date.UTC(+y, +mo - 1, +d, +hh, +mi, +ss);
      }

      m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?/);
      if (m) {
        const [, d, mo, y, hh = '00', mi = '00', ss = '00'] = m;
        return Date.UTC(+y, +mo - 1, +d, +hh, +mi, +ss);
      }

      const ts = Date.parse(s);
      return isNaN(ts) ? 0 : ts;
    }

    function getItemDateMillis(ag) {
      const candidate = ag.data_ordem || ag.data_iso || ag.data;
      return parseDateToMillis(candidate);
    }

    async function carregarAgendamentos(page = 1) {
      const { nome, status, cargo } = getFilters();
      const signature = buildSignature({nome, status, cargo}, page);
      lastSignature = signature;

      if (currentController) currentController.abort();
      currentController = new AbortController();

      const container = document.getElementById("resultadoAgendamentos");
      container.innerHTML = `<div class="loading">Carregando...</div>`;

      try {
        const params = new URLSearchParams({ page, nome, status, cargo });
        const csrf = getCSRFToken();
        const res = await fetch(`/admin/agendamentos/ajax?${params.toString()}`, {
          signal: currentController.signal,
          headers: { "X-CSRFToken": csrf }
        });

        if (!res.ok) {
          container.innerHTML = `<p class="loading" style="color:#b91c1c;">Erro ao carregar dados (${res.status}).</p>`;
          return;
        }

        const data = await res.json();
        const nowSignature = buildSignature(data.filters || {nome:"",status:"",cargo:""}, data.page || 1);
        if (nowSignature !== lastSignature) return;

        let html = "";

        if (data.dados && data.dados.length > 0) {
          data.dados.forEach((f) => {
            const detailsId = `details-${f.id}`;

            const ags = (f.agendamentos || []).slice().sort((a, b) => {
              return getItemDateMillis(b) - getItemDateMillis(a);
            });

            html += `
              <article class="employee-card">
                <button type="button" class="employee-header" onclick="toggleDetails('${detailsId}', this)">
                  <div class="employee-header-left">
                    <div class="employee-avatar"><i class="fas fa-user"></i></div>
                    <p class="employee-name">${escapeHtml(f.funcionario)}</p>
                  </div>
                  <div class="employee-header-right">
                    <span>${escapeHtml(f.cargo || "")}</span>
                    <i class="fas fa-chevron-down"></i>
                  </div>
                </button>

                <div id="${detailsId}" class="employee-details">
                  <div class="employee-table-wrapper">
                    <table class="employee-table">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Motivo</th>
                          <th>Status</th>
                          <th>Substituição</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody>
            `;

            ags.forEach(ag => {
              const st = (ag.status || "").toLowerCase();
              let cls = "", icon = "", label = ag.status || "";
              if (st.startsWith("deferido")) {
                cls = "status-deferido"; icon = '<i class="fas fa-check-circle"></i>'; label = "Deferido";
              } else if (st.startsWith("indeferido")) {
                cls = "status-indeferido"; icon = '<i class="fas fa-times-circle"></i>'; label = "Indeferido";
              } else if (["em_espera","pendente","em espera"].includes(st)) {
                cls = "status-em-espera"; icon = '<i class="fas fa-hourglass-half"></i>'; label = "Em espera";
              }

              const nomeSub = (ag.nome_substituto || "").trim();
              const subHtml = nomeSub
                ? `<span class="sub-badge" title="${escapeHtml(nomeSub)}"><i class="fas fa-user-friends"></i>${escapeHtml(nomeSub)}</span>`
                : `<span class="sub-badge muted" title="Sem substituição">-</span>`;

              const safeNomeSub = escapeHtml(nomeSub);

              html += `
                <tr data-ag-id="${ag.id}" data-sub-nome="${safeNomeSub}">
                  <td>${escapeHtml(ag.data || "")}</td>
                  <td>${escapeHtml(ag.motivo || "")}</td>
                  <td><span class="${cls}">${icon} ${escapeHtml(label)}</span></td>
                  <td class="sub-cell">${subHtml}</td>
                  <td>
                    <div class="sub-actions">
                      <button type="button" class="sub-btn" onclick="openSubModal(${ag.id})" title="Editar substituição">
                        <i class="fas fa-pen"></i>
                        <span class="btn-text">Substituição</span>
                      </button>
                      <button type="button" class="submit-btn" onclick="excluirAgendamento(${ag.id})" title="Excluir agendamento">
                        <i class="fas fa-trash-alt"></i>
                        <span class="btn-text">Excluir</span>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
            });

            html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </article>
            `;
          });

          if (data.pages && data.pages > 1) {
            html += `<div class="pagination">`;
            if (data.has_prev) {
              html += `<a onclick="carregarAgendamentos(${data.prev_num})">&laquo; Anterior</a>`;
            }
            html += `<span>Página ${data.page} de ${data.pages}</span>`;
            if (data.has_next) {
              html += `<a onclick="carregarAgendamentos(${data.next_num})">Próxima &raquo;</a>`;
            }
            html += `</div>`;
          }
        } else {
          const f = getFilters();
          let motivo = "Nenhum agendamento encontrado.";
          if (f.status || f.cargo || f.nome) motivo = "Nenhum agendamento encontrado para os filtros aplicados.";
          html = `<p class="loading">${escapeHtml(motivo)}</p>`;
        }

        container.innerHTML = html;
      } catch (err) {
        if (err.name === "AbortError") return;
        container.innerHTML = `<p class="loading" style="color:#b91c1c;">Falha na conexão.</p>`;
      }
    }

    async function excluirAgendamento(id) {
      if (!confirm("Deseja realmente excluir este agendamento?")) return;

      try {
        const csrf = getCSRFToken();
        const res = await fetch(`/admin/delete_agendamento/${id}`, {
          method: "POST",
          headers: { "X-CSRFToken": csrf }
        });
        const data = await res.json();

        if (data.success) {
          showAlert(data.message || "Agendamento excluído com sucesso.", "success");
          scheduleLoad(1);
        } else {
          showAlert(data.error || "Não foi possível excluir.", "error");
        }
      } catch (err) {
        showAlert("Falha na conexão ao excluir.", "error");
      }
    }

    function toggleDetails(id, headerEl) {
      const content = document.getElementById(id);
      if (!content) return;
      const open = !(content.style.display === "block");
      content.style.display = open ? "block" : "none";
      if (headerEl) headerEl.classList.toggle("open", open);
    }

    function scheduleLoad(page = 1) {
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => carregarAgendamentos(page), DEBOUNCE_MS);
    }

    document.getElementById("filtroNome").addEventListener("input", () => scheduleLoad(1));
    document.getElementById("filtroStatus").addEventListener("change", () => scheduleLoad(1));
    document.getElementById("filtroCargo").addEventListener("change", () => scheduleLoad(1));
    document.getElementById("btnLimpar").addEventListener("click", (e) => {
      e.preventDefault();
      document.getElementById("filtroNome").value  = "";
      document.getElementById("filtroStatus").value = "";
      document.getElementById("filtroCargo").value  = "";
      scheduleLoad(1);
    });

    // ===== Modal / Substituição (Admin) =====
    let subCurrentAgId = null;

    function openSubModal(agId) {
      subCurrentAgId = agId;

      const row = document.querySelector(`tr[data-ag-id="${agId}"]`);
      const current = row ? (row.getAttribute('data-sub-nome') || '') : '';

      const modal = document.getElementById('subModal');
      const input = document.getElementById('subNomeInput');

      input.value = current || '';
      modal.classList.add('open');
      setTimeout(() => input.focus(), 50);
    }

    function closeSubModal() {
      const modal = document.getElementById('subModal');
      modal.classList.remove('open');
      subCurrentAgId = null;
    }

    function clearSubNome() {
      const input = document.getElementById('subNomeInput');
      input.value = '';
      input.focus();
    }

    async function saveSubNome() {
      if (!subCurrentAgId) return;

      const input = document.getElementById('subNomeInput');
      const nome = (input.value || '').trim();
      const csrf = getCSRFToken();

      try {
        const res = await fetch(`/admin/agendamento/${subCurrentAgId}/substituto`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf
          },
          body: JSON.stringify({ nome_substituto: nome })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          const msg = data.error || `Erro ao salvar (${res.status}).`;
          showAlert(msg, "error");
          return;
        }

        const row = document.querySelector(`tr[data-ag-id="${subCurrentAgId}"]`);
        if (row) {
          row.setAttribute('data-sub-nome', escapeHtml(nome));

          const cell = row.querySelector('.sub-cell');
          if (cell) {
            if (nome) {
              cell.innerHTML = `<span class="sub-badge" title="${escapeHtml(nome)}"><i class="fas fa-user-friends"></i>${escapeHtml(nome)}</span>`;
            } else {
              cell.innerHTML = `<span class="sub-badge muted" title="Sem substituição">-</span>`;
            }
          }
        }

        showAlert("Substituição atualizada com sucesso.", "success");
        closeSubModal();
      } catch (err) {
        showAlert("Falha na conexão ao salvar substituição.", "error");
      }
    }

    document.addEventListener('click', (e) => {
      const modal = document.getElementById('subModal');
      if (!modal.classList.contains('open')) return;
      if (e.target === modal) closeSubModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSubModal();
    });

    carregarAgendamentos(1);
  </script>
</body>
</html>
