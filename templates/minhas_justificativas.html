<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meus Agendamentos</title>

  <!-- CSRF -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f3f4f6; --ink:#0f172a; --muted:#6b7280; --brand:#0d6efd; --brand-soft:#e0edff;
      --border-soft:#e5e7eb; --card-shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 4px rgba(15,23,42,.05);
      --radius:18px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:'Montserrat',sans-serif; display:flex; flex-direction:column; min-height:100vh; }
    body{ overflow-y:auto; }
    main{ flex:1 0 auto; padding:24px 12px 70px; }
    .shell{ max-width:1000px; margin:0 auto; }
    @media (min-width:769px){ main{ padding:30px 24px 90px; } }

    /* Headers (mesmos estilos do seu projeto) */
    .header-desktop,.header-mobile{ display:none; flex-shrink:0; }
    @media (min-width:769px){
      .header-desktop{ display:flex; background:#007bff; padding:15px 30px; width:100%; align-items:center; justify-content:space-between; min-height:110px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.15); color:#fff; }
      .left-section{ display:flex; align-items:center; gap:20px; }
      .logo{ width:80px; height:80px; object-fit:contain; border-radius:10px; background:#fff; padding:6px; }
      .text-container{ display:flex; flex-direction:column; color:#fff; }
      .escola-nome{ font-weight:700; font-size:1.6rem; margin:0; line-height:1.1; }
      .escola-subtitulo{ font-weight:600; font-size:1.1rem; margin-top:4px; }
      .header-center-text-container{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-weight:800; font-size:1.9rem; color:#fff; letter-spacing:5px; user-select:none; white-space:nowrap; text-shadow:0 2px 5px rgba(0,0,0,.3); }
      .btn-home{ background:#0fb300; color:#fff; padding:6px 14px; border-radius:6px; font-weight:700; font-size:1.5rem; text-decoration:none; display:flex; align-items:center; gap:8px; box-shadow:0 2px 6px rgba(15,179,0,.8); transition:.3s; position:absolute; right:30px; top:50%; transform:translateY(-50%); z-index:2; }
      .btn-home:hover{ background:#0d8a00; }
    }
    @media (max-width:768px){
      .header-mobile{ display:block; width:100%; color:#fff; position:sticky; top:0; z-index:1000; box-shadow:0 2px 6px rgba(0,0,0,.15); background:#007bff; }
      .header-top{ display:flex; align-items:center; justify-content:center; gap:15px; padding:10px 15px; background:#007bff; text-align:center; }
      .logo{ width:48px; height:48px; object-fit:contain; border-radius:10px; background:#fff; padding:6px; }
      .text-container{ display:flex; flex-direction:column; text-align:center; }
      .escola-nome{ font-weight:700; font-size:1.3rem; margin:0; line-height:1.1; }
      .escola-subtitulo{ font-weight:600; font-size:1rem; margin-top:2px; }
      .header-bottom{ background:#0056b3; text-align:center; padding:12px 10px; font-weight:800; font-size:1rem; letter-spacing:4px; user-select:none; color:#fff; box-shadow:inset 0 -2px 5px rgba(0,0,0,.2); display:flex; justify-content:center; align-items:center; gap:12px; position:relative; white-space:nowrap; }
      .btn-home-mobile{ background:#0fb300; color:#fff; padding:6px 10px; border-radius:6px; font-weight:600; font-size:1rem; text-decoration:none; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(15,179,0,.8); transition:.3s; }
      .btn-home-mobile:hover{ background:#0d8a00; }
    }

    /* Header da página */
    .page-header-card{ background:#fff; border-radius:var(--radius); padding:16px 18px; margin-bottom:18px; display:flex; align-items:center; gap:16px; box-shadow:var(--card-shadow); border-left:5px solid var(--brand); }
    .page-header-icon{ display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:999px; background:radial-gradient(circle at 30% 30%,#fff 0%,var(--brand-soft) 60%,#c7d9ff 100%); box-shadow:0 4px 12px rgba(37,99,235,.45); color:#2563eb; flex-shrink:0; }
    .page-header-icon i{ font-size:22px; }
    .page-header-content{ display:flex; flex-direction:column; gap:4px; }
    .page-header-title{ font-size:1.2rem; font-weight:800; margin:0; color:var(--ink); }
    .page-header-subtitle{ font-size:.9rem; margin:0; color:var(--muted); }
    @media (max-width:600px){ .page-header-card{ padding:12px 14px; margin-bottom:14px; } .page-header-title{ font-size:1.05rem; } .page-header-subtitle{ font-size:.82rem; } }

    /* Flash */
    .flash-messages{ margin-bottom:14px; }
    .flash{ padding:9px 12px; border-radius:12px; margin-bottom:6px; font-size:.86rem; font-weight:600; display:flex; align-items:center; gap:8px; box-shadow:0 3px 10px rgba(15,23,42,.08); }
    .flash.success{ background:#e8f7ee; color:#065f46; border:1px solid #b7ebc6; }
    .flash.danger{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .flash.warning{ background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
    .flash.info{ background:#e0edff; color:#1d4ed8; border:1px solid #bfdbfe; }

    /* Card da lista */
    .agenda-card{ width:100%; background:#fff; border-radius:var(--radius); box-shadow:var(--card-shadow); padding:18px 16px 20px; border:1px solid rgba(148,163,184,.25); margin-bottom:18px; }
    .agenda-headline{ display:flex; flex-direction:column; gap:4px; margin-bottom:12px; }
    .agenda-title{ font-size:1.05rem; font-weight:800; color:var(--ink); }
    .agenda-subtitle{ font-size:.86rem; color:var(--muted); }
    @media (min-width:640px){ .agenda-headline{ flex-direction:row; justify-content:space-between; align-items:center; } .agenda-title{ font-size:1.1rem; } }

    /* Controles (busca, filtro, tamanho de página) */
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:8px 0 12px; }
    .controls .control{ display:flex; align-items:center; gap:6px; }
    .controls input[type="search"], .controls select{
      padding:8px 10px; border:1px solid var(--border-soft); border-radius:10px; font-size:.9rem; background:#fff;
    }
    .summary{ font-size:.86rem; color:#4b5563; margin-left:auto; }

    /* Tabela + responsividade */
    .table-wrapper{ overflow-x:auto; border:1px solid #eef2f7; border-radius:12px; }
    table{ width:100%; border-collapse:collapse; font-size:.9rem; }
    thead th{ background:#f8fafc; color:#0f172a; padding:10px 8px; font-weight:800; text-align:center; border-bottom:1px solid #e5e7eb; white-space:nowrap; position:sticky; top:0; z-index:1; }
    tbody td{ padding:8px 6px; border-bottom:1px solid #e5e7eb; text-align:center; color:#111827; vertical-align:middle; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    tbody tr:hover{ background:#f7fbff; }
    @media (max-width:768px){ thead th,tbody td{ font-size:.8rem; padding:6px 4px; } }

    /* Status pill */
    .status-pill{ display:inline-flex; align-items:center; justify-content:center; padding:2px 10px; border-radius:999px; font-size:.8rem; font-weight:700; white-space:nowrap; }
    .status-pill.espera{ background:#fef3c7; color:#92400e; }
    .status-pill.pendente{ background:#fef3c7; color:#92400e; }
    .status-pill.deferido{ background:#d1fae5; color:#065f46; }
    .status-pill.indeferido{ background:#fee2e2; color:#991b1b; }

    /* Protocolo (PDF) */
    .proto-link{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:800;
      font-size:.82rem;
      text-decoration:none;
      transition:.2s ease;
      white-space:nowrap;
    }
    .proto-link i{ font-size:14px; }
    .proto-link:hover{ background:#dbeafe; border-color:#bfdbfe; color:#1e40af; }

    /* Ações */
    .delete-btn{ font-size:1.1rem; color:#e74c3c; cursor:pointer; background:none; border:none; padding:0; margin:0; line-height:1; display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:50%; transition:.2s; }
    .delete-btn:hover{ color:#c0392b; background:rgba(231,76,60,.12); }
    .no-data{ text-align:center; margin-top:10px; font-size:.95rem; color:var(--muted); }

    /* Paginação */
    .pagination{ margin-top:14px; display:flex; justify-content:center; align-items:center; gap:6px; flex-wrap:wrap; }
    .pagination button{ border:1px solid #007bff; background:#fff; color:#007bff; padding:4px 9px; border-radius:6px; cursor:pointer; font-size:.85rem; }
    .pagination button:hover:not(.active):not(:disabled){ background:#007bff; color:#fff; }
    .pagination button.active{ background:#007bff; color:#fff; font-weight:700; }
    .pagination button:disabled{ opacity:.5; cursor:default; }
    .pagination span{ font-size:.85rem; color:#555; }

    /* Modal (base) */
    .modal{ display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.55); justify-content:center; align-items:center; padding:10px; }

    /* Confirmação excluir (mantém o layout atual) */
    .modal-content{ background:#fff; padding:20px; border-radius:14px; width:90%; max-width:320px; text-align:center; box-shadow:0 4px 18px rgba(0,0,0,.25); }
    .modal-content h2{ margin:0 0 8px 0; font-size:1.1rem; font-weight:800; color:#111827; }
    .modal-content p{ margin:0 0 14px 0; font-size:.9rem; color:#4b5563; }
    .btn{ margin:4px 6px; padding:9px 18px; border:none; cursor:pointer; border-radius:999px; font-size:.9rem; font-weight:700; transition:.25s; }
    .btn-danger{ background:#ef4444; color:#fff; box-shadow:0 6px 14px rgba(239,68,68,.55); }
    .btn-danger:hover{ background:#dc2626; }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-secondary:hover{ background:#d1d5db; }

    /* Link voltar */
    .voltar-wrapper{ text-align:center; margin-top:4px; }
    .voltar-link{ display:inline-flex; align-items:center; gap:6px; margin:0 auto; font-size:.90rem; color:#2563eb; text-decoration:none; font-weight:700; }
    .voltar-link:hover{ text-decoration:underline; }

    /* Rodapé */
    footer{ background:linear-gradient(to right,#222,#444); color:#ddd; text-align:center; padding:15px 0; font-size:14px; border-top:2px solid #555; box-shadow:0 -2px 10px rgba(0,0,0,.3); width:100%; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* ====== Substituição (célula) ====== */
    .sub-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      max-width:360px;
      margin:0 auto;
    }
    .sub-text{
      display:inline-block;
      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-weight:800;
      color:#111827;
    }
    .sub-text.muted{
      color:#6b7280;
      font-weight:700;
    }
    .sub-edit-btn{
      border:none;
      background:#eef6ff;
      color:#1d4ed8;
      width:28px;
      height:28px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 8px rgba(29,78,216,.12);
      transition:.2s;
      flex:0 0 auto;
    }
    .sub-edit-btn:hover{
      background:#dbeafe;
      color:#1e40af;
      transform:translateY(-1px);
    }
    .sub-edit-btn:active{ transform:translateY(0); }

    /* ====== (NOVO) Modal de Substituição (igual calendário: M/I/T/N) ====== */
    .sub-modal-content{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.35);
      text-align:left;
    }
    .sub-modal-header{
      padding:14px 16px;
      background:linear-gradient(90deg,#f9fafb 0,#eef2ff 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sub-modal-title{
      margin:0;
      font-size:1rem;
      font-weight:900;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .sub-modal-close{
      border:none;
      background:transparent;
      cursor:pointer;
      color:#64748b;
      font-size:1.1rem;
      padding:6px 8px;
      border-radius:10px;
      transition:background .15s ease, color .15s ease;
    }
    .sub-modal-close:hover{ background:rgba(100,116,139,.12); color:#0f172a; }
    .sub-modal-body{ padding:14px 16px 16px; background:#fff; }
    .sub-modal-help{
      margin:0 0 10px;
      color:#6b7280;
      font-size:.86rem;
      line-height:1.25rem;
    }

    .sub-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:520px){ .sub-grid{ grid-template-columns:1fr; } }

    .sub-modal-field{ display:grid; gap:6px; }
    .sub-modal-label{
      font-size:.78rem;
      text-transform:uppercase;
      color:#6b7280;
      letter-spacing:.08em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      font-size:.8rem;
      font-weight:900;
      background:#eef2ff;
      color:#1d4ed8;
      border:1px solid rgba(29,78,216,.25);
      flex:0 0 auto;
    }
    .sub-modal-input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      font-size:.95rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
      font-weight:700;
    }
    .sub-modal-input:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.45);
    }

    .sub-modal-actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .sub-btn-secondary{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      color:#111827;
      font-weight:900;
      cursor:pointer;
    }
    .sub-btn-secondary:hover{ background:#e5e7eb; }

    .sub-btn-primary{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #1d4ed8;
      background:#2563eb;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(37,99,235,.25);
    }
    .sub-btn-primary:hover{ background:#1d4ed8; }

    .sub-btn-danger-soft{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #fecaca;
      background:#fee2e2;
      color:#b91c1c;
      font-weight:900;
      cursor:pointer;
    }
    .sub-btn-danger-soft:hover{ background:#fecaca; }
  </style>
</head>

<body>
  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-center-text-container">PORTAL DO SERVIDOR</div>
    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial"><i class="fas fa-home"></i></a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial"><i class="fas fa-home"></i></a>
    </div>
  </header>

  <main>
    <div class="shell">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash {{ category }}">
                {% if category == 'success' %}<i class="fas fa-check-circle"></i>
                {% elif category in ['danger','error'] %}<i class="fas fa-exclamation-circle"></i>
                {% elif category == 'warning' %}<i class="fas fa-exclamation-triangle"></i>
                {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Cabeçalho da página -->
      <div class="page-header-card">
        <div class="page-header-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="page-header-content">
          <p class="page-header-title">Meus Agendamentos</p>
          <p class="page-header-subtitle">Visualize, filtre e cancele agendamentos em espera.</p>
        </div>
      </div>

      <!-- Card principal -->
      <div class="agenda-card">
        <div class="agenda-headline">
          <div class="agenda-title">Agendamentos de {{ current_user.nome }}</div>
          <div class="agenda-subtitle">Mais recentes primeiro.</div>
        </div>

        <!-- Controles -->
        <div class="controls" aria-label="Controles de listagem">
          <div class="control">
            <label for="q" class="sr-only">Buscar</label>
            <input id="q" type="search" placeholder="Buscar por motivo/data…" aria-label="Buscar">
          </div>
          <div class="control">
            <label for="status" class="sr-only">Status</label>
            <select id="status" aria-label="Filtrar por status">
              <option value="">Todos os status</option>
              <option value="em_espera">Em Espera</option>
              <option value="pendente">Pendente</option>
              <option value="deferido">Deferido</option>
              <option value="indeferido">Indeferido</option>
            </select>
          </div>
          <div class="control">
            <label for="pageSize" class="sr-only">Itens por página</label>
            <select id="pageSize" aria-label="Itens por página">
              <option value="5">5 por página</option>
              <option value="10" selected>10 por página</option>
              <option value="20">20 por página</option>
            </select>
          </div>
          <div id="summary" class="summary" aria-live="polite"></div>
        </div>

        {% if agendamentos %}
          <div class="table-wrapper">
            <table id="agendamentosTable">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Motivo</th>
                  <th>Status</th>
                  <th>Substituição</th>
                  <th>Protocolo</th>
                  <th>Opções</th>
                </tr>
              </thead>
              <tbody>
                {% set status_map = {'em_espera':'Em Espera','pendente':'Pendente','deferido':'Deferido','indeferido':'Indeferido'} %}
                {% set motivo_map = {
                  'AB':'Abonada',
                  'BH':'Banco de Horas',
                  'DS':'Doação de Sangue',
                  'TRE':'TRE',
                  'LM':'Licença Médica',
                  'FS':'Falta Simples',
                  'DL':'Dispensa Legal'
                } %}
                {% for ag in agendamentos|sort(attribute='data', reverse=True) %}
                {% set s = (ag.status or '')|lower %}
                {% set mraw = (ag.motivo or '') %}
                {% set mkey = (mraw|string)|trim|upper %}
                {% set sub_nome = (ag.nome_substituto or '')|string|trim %}
                {% set motivo_label = motivo_map.get(mkey, ag.motivo | default('Não informado')) %}
                <tr data-status="{{ s }}">
                  <td>{{ ag.data.strftime('%d/%m/%Y') }}</td>

                  <td>{{ motivo_label }}</td>

                  <td>
                    <span class="status-pill
                      {% if s == 'em_espera' %}espera
                      {% elif s == 'pendente' %}pendente
                      {% elif s == 'deferido' %}deferido
                      {% elif s == 'indeferido' %}indeferido
                      {% endif %}">
                      {{ status_map.get(s, 'Status Desconhecido') }}
                    </span>
                  </td>

                  <!-- Substituição -->
                  <td>
                    <div class="sub-cell">
                      <span class="sub-text {% if not sub_nome %}muted{% endif %}">
                        {% if sub_nome %}
                          {{ sub_nome }}
                        {% else %}
                          —
                        {% endif %}
                      </span>

                      <button
                        type="button"
                        class="sub-edit-btn js-edit-sub"
                        title="Editar substituições (M/I/T/N)"
                        data-url="{{ url_for('atualizar_substituto_agendamento', agendamento_id=ag.id) }}"
                        data-current="{{ sub_nome|e }}"
                        data-info="{{ (ag.data.strftime('%d/%m/%Y') ~ ' — ' ~ motivo_label)|e }}"
                      >
                        <i class="fas fa-pen"></i>
                      </button>
                    </div>
                  </td>

                  <!-- Protocolo PDF -->
                  <td>
                    <a class="proto-link"
                       href="{{ url_for('agendamento_protocolo', agendamento_id=ag.id) }}"
                       target="_blank"
                       rel="noopener"
                       title="Abrir protocolo em PDF">
                      <i class="fas fa-file-pdf" aria-hidden="true"></i>
                      <span>Protocolo</span>
                    </a>
                  </td>

                  <td>
                    {% if s in ['em_espera', 'pendente'] %}
                      <a href="javascript:void(0);" class="delete-btn" onclick="confirmDelete({{ ag.id }})" title="Excluir agendamento">
                        <i class="fas fa-times"></i>
                      </a>
                    {% else %}
                      <span style="font-size:.8rem; color:#6b7280;">—</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginação -->
          <nav id="pagination" class="pagination" aria-label="Paginação"></nav>
        {% else %}
          <div class="no-data">Você não tem agendamentos cadastrados.</div>
        {% endif %}
      </div>

      <div class="voltar-wrapper">
        <a href="{{ url_for('index') }}" class="voltar-link"><i class="fas fa-arrow-left"></i> Voltar para a Página Inicial</a>
      </div>
    </div>
  </main>

  <!-- Modal de Confirmação (Excluir) -->
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content">
      <h2 id="confirmTitle">Excluir agendamento</h2>
      <p>Você tem certeza de que deseja excluir este agendamento?</p>
      <form id="confirmDeleteForm" action="" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button id="confirmDeleteBtn" class="btn btn-danger">Sim, excluir</button>
        <button id="cancelDeleteBtn" type="button" class="btn btn-secondary">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- ✅ Modal de Substituição (IGUAL ao Calendário: M/I/T/N) -->
  <div id="subModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="subModalTitle">
    <div class="sub-modal-content">
      <div class="sub-modal-header">
        <h3 class="sub-modal-title" id="subModalTitle">
          <i class="fas fa-user-edit"></i>
          Substitutos por Turno (Agendamento)
        </h3>
        <button type="button" class="sub-modal-close" aria-label="Fechar" id="subCloseBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="sub-modal-body">
        <p class="sub-modal-help" id="subModalHelp">
          Preencha os turnos (M/I/T/N). Se deixar tudo em branco, remove substitutos.
        </p>

        <div class="sub-grid">
          <div class="sub-modal-field">
            <div class="sub-modal-label"><span class="pill">M</span> Manhã</div>
            <input id="subM" class="sub-modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="sub-modal-field">
            <div class="sub-modal-label"><span class="pill">I</span> Intermediário</div>
            <input id="subI" class="sub-modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="sub-modal-field">
            <div class="sub-modal-label"><span class="pill">T</span> Tarde</div>
            <input id="subT" class="sub-modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="sub-modal-field">
            <div class="sub-modal-label"><span class="pill">N</span> Noite</div>
            <input id="subN" class="sub-modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>
        </div>

        <div class="sub-modal-actions">
          <button type="button" class="sub-btn-danger-soft" id="subClearBtn">
            <i class="fas fa-eraser"></i>
            Limpar
          </button>
          <button type="button" class="sub-btn-secondary" id="subCancelBtn">
            Cancelar
          </button>
          <button type="button" class="sub-btn-primary" id="subSaveBtn">
            <i class="fas fa-save"></i>
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <script>
    // CSRF global
    (function () {
      const el = document.querySelector('meta[name="csrf-token"]');
      if (el) window.csrfToken = el.getAttribute('content');
    })();

    // =========================
    // Modal de exclusão
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      let agendamentoIdToDelete = null;
      const modal = document.getElementById('confirmModal');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const cancelBtn = document.getElementById('cancelDeleteBtn');

      window.confirmDelete = function (id) {
        agendamentoIdToDelete = id;
        document.getElementById('confirmDeleteForm').action = '/delete_agendamento/' + id;
        modal.style.display = 'flex';
      };

      confirmBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        if (agendamentoIdToDelete) document.getElementById('confirmDeleteForm').submit();
      });
      cancelBtn?.addEventListener('click', () => modal.style.display = 'none');
      window.addEventListener('pageshow', () => { modal.style.display = 'none'; agendamentoIdToDelete = null; });
    });

    // =========================================================
    // Substitutos (IGUAL ao calendário): parse / serialize
    // =========================================================
    const SHIFT_KEYS = ['M','I','T','N'];

    function cleanSpaces(s) {
      return String(s ?? '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function normalizeKey(raw) {
      const t = cleanSpaces(raw).toUpperCase();
      if (t === 'M' || t.startsWith('MANH')) return 'M';
      if (t === 'I' || t.startsWith('INTER')) return 'I';
      if (t === 'T' || t.startsWith('TAR')) return 'T';
      if (t === 'N' || t.startsWith('NOI')) return 'N';
      const c = t.charAt(0);
      if (SHIFT_KEYS.includes(c)) return c;
      return null;
    }

    function parseSubstitutoString(input) {
      const out = { M:'', I:'', T:'', N:'' };

      let s = String(input ?? '');
      if (!s.trim()) return out;

      s = s.replace(/^\s*\(?\s*substituto\s*:\s*/i, '');
      s = s.replace(/\)?\s*$/,'');
      s = s.replace(/\r\n/g, '\n');

      const unified = s
        .replace(/[|]/g, ';')
        .replace(/\n+/g, ';')
        .replace(/,+/g, ';')
        .replace(/;+/, ';');

      const re = /(^|[;])\s*(M|I|T|N|MANH[ÃA]?|INTERMEDI[ÁA]RIO|INTERMEDIARIO|TARDE|NOITE)\s*[:=\-]\s*([^;]+)\s*/ig;
      let found = false;
      let match;
      while ((match = re.exec(unified)) !== null) {
        found = true;
        const k = normalizeKey(match[2]);
        const v = cleanSpaces(match[3]);
        if (!k || !v) continue;
        if (!out[k]) out[k] = v;
        else if (out[k].toLowerCase() !== v.toLowerCase()) out[k] = cleanSpaces(out[k] + ' / ' + v);
      }
      if (found) return out;

      const parts = unified
        .split(';')
        .map(p => cleanSpaces(p))
        .filter(Boolean);

      if (parts.length === 0) return out;
      if (parts.length === 1) { out.M = parts[0]; return out; }

      for (let i=0; i<parts.length && i<4; i++) out[SHIFT_KEYS[i]] = parts[i];

      if (parts.length > 4) {
        const rest = parts.slice(4).join(' / ');
        out.N = cleanSpaces([out.N, rest].filter(Boolean).join(' / '));
      }

      return out;
    }

    function serializeSubstituto(obj) {
      const pieces = [];
      for (const k of SHIFT_KEYS) {
        const v = cleanSpaces(obj?.[k] ?? '');
        if (!v) continue;

        const normalizedPieces = [];
        for (const part of v.split('/')) {
          const c = cleanSpaces(part);
          if (!c) continue;
          const key = c.toLowerCase();
          if (normalizedPieces.some(x => x.toLowerCase() === key)) continue;
          normalizedPieces.push(c);
        }
        pieces.push(`${k}: ${normalizedPieces.join(' / ')}`);
      }
      return pieces.join('; ');
    }

    function setSubCellText(textEl, value) {
      const v = cleanSpaces(value);
      if (!textEl) return;
      if (v) {
        textEl.textContent = v;
        textEl.classList.remove('muted');
      } else {
        textEl.textContent = '—';
        textEl.classList.add('muted');
      }
    }

    // =========================================================
    // Modal de Substituição (M/I/T/N) + atualização via fetch
    // =========================================================
    document.addEventListener('DOMContentLoaded', () => {
      const subModal = document.getElementById('subModal');
      const subHelp  = document.getElementById('subModalHelp');

      const subM = document.getElementById('subM');
      const subI = document.getElementById('subI');
      const subT = document.getElementById('subT');
      const subN = document.getElementById('subN');

      const subSaveBtn   = document.getElementById('subSaveBtn');
      const subCancelBtn = document.getElementById('subCancelBtn');
      const subClearBtn  = document.getElementById('subClearBtn');
      const subCloseBtn  = document.getElementById('subCloseBtn');

      let currentBtn = null;     // botão clicado (tem data-url)
      let currentTextEl = null;  // span da célula

      function openSubModal(btn){
        currentBtn = btn;
        const tr = btn.closest('tr');
        currentTextEl = tr ? tr.querySelector('.sub-text') : null;

        const currentRaw = btn.getAttribute('data-current') || '';
        const info = btn.getAttribute('data-info') || '';

        if (subHelp) {
          subHelp.textContent = info
            ? `Agendamento: ${info}. Preencha M/I/T/N (em branco remove).`
            : 'Preencha os turnos (M/I/T/N). Se deixar tudo em branco, remove substitutos.';
        }

        const parsed = parseSubstitutoString(currentRaw);
        subM.value = parsed.M || '';
        subI.value = parsed.I || '';
        subT.value = parsed.T || '';
        subN.value = parsed.N || '';

        subModal.style.display = 'flex';
        setTimeout(() => subM.focus(), 50);
      }

      function closeSubModal(){
        subModal.style.display = 'none';
        if (subSaveBtn) subSaveBtn.disabled = false;
        currentBtn = null;
        currentTextEl = null;
      }

      function clearSubTurnos(){
        subM.value = '';
        subI.value = '';
        subT.value = '';
        subN.value = '';
        subM.focus();
      }

      document.querySelectorAll('.js-edit-sub').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openSubModal(btn);
        });
      });

      subCancelBtn?.addEventListener('click', closeSubModal);
      subCloseBtn?.addEventListener('click', closeSubModal);
      subClearBtn?.addEventListener('click', clearSubTurnos);

      subModal?.addEventListener('click', (e) => { if (e.target === subModal) closeSubModal(); });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && subModal && subModal.style.display === 'flex') {
          closeSubModal();
        }
      });

      subSaveBtn?.addEventListener('click', async () => {
        if (!currentBtn) return;

        subSaveBtn.disabled = true;

        const url = currentBtn.getAttribute('data-url');

        const obj = {
          M: subM.value,
          I: subI.value,
          T: subT.value,
          N: subN.value,
        };

        const serialized = serializeSubstituto(obj); // ✅ igual calendário (M: ...; I: ...)

        try{
          const resp = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': window.csrfToken || '',
              'X-CSRF-Token': window.csrfToken || ''
            },
            credentials: 'same-origin',
            body: JSON.stringify({ nome_substituto: serialized })
          });

          if (!resp.ok) {
            const txt = await resp.text().catch(() => '');
            console.error('Erro HTTP ao salvar substituição:', resp.status, txt);
            throw new Error('Erro ao salvar (HTTP ' + resp.status + ').');
          }

          const data = await resp.json().catch(() => null);
          if (!data || !data.success) {
            console.error('Resposta inválida ao salvar substituição:', data);
            throw new Error((data && data.error) || 'Não foi possível salvar a substituição.');
          }

          const novoNome = (data.nome_substituto || '').toString().trim();

          // Atualiza dataset do botão
          currentBtn.setAttribute('data-current', novoNome);

          // Atualiza UI da célula
          setSubCellText(currentTextEl, novoNome);

          closeSubModal();
        } catch (err) {
          console.error(err);
          subSaveBtn.disabled = false;
          alert(err && err.message ? err.message : 'Não foi possível salvar a substituição.');
        }
      });

      window.addEventListener('pageshow', () => closeSubModal());
    });

    // =========================
    // Paginação + filtros (front-end)
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('agendamentosTable');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const q = document.getElementById('q');
      const statusSel = document.getElementById('status');
      const pageSizeSel = document.getElementById('pageSize');
      const pagination = document.getElementById('pagination');
      const summary = document.getElementById('summary');

      let rowsPerPage = parseInt(localStorage.getItem('ag_page_size') || '10', 10);
      pageSizeSel.value = String(rowsPerPage);
      let currentPage = 1;
      let filteredRows = allRows.slice();

      function normalize(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

      function applyFilters(){
        const qv = normalize(q.value);
        const sv = statusSel.value;

        filteredRows = allRows.filter(row => {
          const statusOk = !sv || (row.dataset.status === sv);
          if (!statusOk) return false;
          if (!qv) return true;
          const text = normalize(row.textContent);
          return text.includes(qv);
        });

        const maxPage = Math.max(1, Math.ceil(filteredRows.length / rowsPerPage));
        if (currentPage > maxPage) currentPage = 1;

        render();
      }

      function render(){
        allRows.forEach(r => r.style.display = 'none');

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageRows = filteredRows.slice(start, end);

        pageRows.forEach(r => r.style.display = '');

        renderPagination();
        renderSummary(start, pageRows.length, filteredRows.length);
      }

      function renderSummary(start, count, total){
        const from = total ? (start + 1) : 0;
        const to = start + count;
        summary.textContent = `Mostrando ${from}–${to} de ${total}`;
      }

      function renderPagination(){
        pagination.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil(filteredRows.length / rowsPerPage));
        if (totalPages <= 1) return;

        const addBtn = (label, disabled, onClick, active=false) => {
          const b = document.createElement('button');
          b.textContent = label;
          if (active) b.classList.add('active');
          if (disabled) b.disabled = true;
          if (onClick) b.addEventListener('click', onClick);
          pagination.appendChild(b);
        };

        addBtn('«', currentPage === 1, () => { currentPage--; render(); });

        for (let p = 1; p <= totalPages; p++) {
          if (p === 1 || p === totalPages || (p >= currentPage - 2 && p <= currentPage + 2)) {
            addBtn(String(p), false, () => { currentPage = p; render(); }, p === currentPage);
          } else if (p === currentPage - 3 || p === currentPage + 3) {
            const span = document.createElement('span'); span.textContent = '…'; pagination.appendChild(span);
          }
        }

        addBtn('»', currentPage === totalPages, () => { currentPage++; render(); });
      }

      q.addEventListener('input', () => { currentPage = 1; applyFilters(); });
      statusSel.addEventListener('change', () => { currentPage = 1; applyFilters(); });
      pageSizeSel.addEventListener('change', () => {
        rowsPerPage = parseInt(pageSizeSel.value, 10);
        localStorage.setItem('ag_page_size', String(rowsPerPage));
        currentPage = 1;
        render();
      });

      applyFilters();
    });
  </script>
</body>
</html>
