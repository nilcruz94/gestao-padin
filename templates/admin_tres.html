<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TREs por Servidor</title>

  <!-- Bootstrap / Assets do projeto -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>

  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #0051ff;
      --primary-soft: #dbe9ff;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --warning: #f97316;
      --warning-soft: #ffedd5;
      --danger: #dc2626;
      --danger-soft: #fee2e2;

      --card-shadow: 0 14px 34px rgba(15,23,42,.1), 0 2px 4px rgba(15,23,42,.06);
      --radius: 18px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at top, #e0f2ff 0, #f9fafb 45%, #eef2ff 100%);
      background-attachment: fixed;
      color: var(--text-main);
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    main {
      flex: 1 0 auto;
      padding: 24px 12px 60px;
      box-sizing: border-box;
    }

    .shell {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    @media (min-width: 769px) {
      main {
        padding: 30px 24px 80px;
      }
    }

    /* ===== CABEÇALHOS ===== */
    .header-desktop,
    .header-mobile {
      display: none;
      flex-shrink: 0;
    }

    /* Desktop */
    @media (min-width: 769px) {
      .header-desktop {
        display: flex;
        background-color: #007bff;
        padding: 15px 30px;
        width: 100%;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
        min-height: 110px;
        position: relative;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        color: white;
      }

      .left-section {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: 10px;
        background-color: white;
        padding: 6px;
      }

      .text-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
        color: white;
      }

      .escola-nome {
        font-weight: 700;
        font-size: 1.6rem;
        margin: 0;
        line-height: 1.1;
      }

      .escola-subtitulo {
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 4px;
      }

      .header-center-text-container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: 800;
        font-size: 1.9rem;
        color: white;
        letter-spacing: 5px;
        user-select: none;
        white-space: nowrap;
        z-index: 1;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }

      .header-center-text {
        font-family: 'Montserrat', sans-serif;
      }

      .btn-home {
        background-color: #0fb300;
        color: white;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 1.5rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8);
        transition: background-color 0.3s ease;
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
      }

      .btn-home:hover {
        background-color: #0d8a00;
      }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .header-mobile {
        display: block;
        width: 100%;
        box-sizing: border-box;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        background-color: #007bff;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 10px 15px;
        background-color: #007bff;
        text-align: center;
      }

      .logo {
        width: 48px;
        height: 48px;
        object-fit: contain;
        border-radius: 10px;
        background-color: white;
        padding: 6px;
      }

      .text-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: white;
        text-align: center;
      }

      .escola-nome {
        font-weight: 700;
        font-size: 1.3rem;
        margin: 0;
        line-height: 1.1;
      }

      .escola-subtitulo {
        font-weight: 600;
        font-size: 1rem;
        margin-top: 2px;
      }

      .header-bottom {
        background-color: #0056b3;
        text-align: center;
        padding: 12px 10px;
        font-weight: 800;
        font-size: 1.0rem;
        letter-spacing: 4px;
        user-select: none;
        color: white;
        box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        box-sizing: border-box;
        white-space: nowrap;
      }

      .btn-home-mobile {
        background-color: #0fb300;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8);
        transition: background-color 0.3s ease;
      }

      .btn-home-mobile:hover {
        background-color: #0d8a00;
      }
    }

    /* ===== HEADER CARD DA PÁGINA ===== */
    .page-header-card {
      background: #ffffff;
      border-radius: var(--radius);
      padding: 16px 18px;
      margin: 0 auto 18px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--card-shadow);
      border-left: 5px solid var(--primary);
    }

    .page-header-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, #e0edff 60%, #c7d9ff 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, .45);
      color: #2563eb;
      flex-shrink: 0;
    }

    .page-header-icon i {
      font-size: 22px;
    }

    .page-header-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-header-title {
      font-size: 1.15rem;
      font-weight: 800;
      margin: 0;
      color: var(--text-main);
    }

    .page-header-subtitle {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .page-header-card {
        padding: 12px 14px;
      }

      .page-header-title {
        font-size: 1.05rem;
      }

      .page-header-subtitle {
        font-size: 0.82rem;
      }
    }

    /* ===== CARD GERAL ===== */
    .content-card {
      width: 100%;
      margin: 0 auto 24px;
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 18px 18px 22px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(8px);
      box-sizing: border-box;
    }

    .content-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin: 0 0 6px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .content-title i {
      color: var(--primary);
    }

    .content-subtitle {
      font-size: 0.88rem;
      color: var(--text-muted);
      margin: 0 0 14px;
    }

    /* ===== FLASH MESSAGES ===== */
    .flash-messages {
      margin: 0 auto 16px;
      max-width: 1100px;
    }

    .flash {
      padding: 10px 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flash i {
      font-size: 1rem;
    }

    .flash.success {
      background-color: var(--success-soft);
      color: #065f46;
      border: 1px solid #bbf7d0;
    }

    .flash.error,
    .flash.danger {
      background-color: var(--danger-soft);
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }

    .flash.info {
      background-color: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }

    /* ===== FILTROS ===== */
    .filter-card {
      margin-bottom: 22px;
    }

    .filter-form {
      margin-top: 8px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: 260px minmax(280px,1fr) 140px;
      grid-gap: 16px;
      align-items: end;
    }

    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }
    }

    .filter-card .form-control,
    .filter-card .btn {
      border-radius: 12px;
    }

    .search-input {
      position: relative;
    }

    .search-input input {
      padding-left: 40px;
    }

    .search-input .fa-search {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #9aa3af;
      font-size: 14px;
      pointer-events: none;
      line-height: 1;
    }

    .btn-filter {
      background: linear-gradient(135deg,#0d6efd,#0b5ed7);
      border: 0;
      color: #fff;
      font-weight: 800;
      border-radius: 12px;
      box-shadow: 0 10px 22px rgba(13,110,253,.24);
    }

    /* ===== CARDS POR SERVIDOR ===== */
    .server-card {
      border: 0;
      border-radius: 18px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 14px 34px rgba(2,6,23,.09), 0 1px 2px rgba(2,6,23,.06);
      margin-bottom: 16px;
    }

    .server-head {
      background: #f8fafc;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .server-name {
      margin: 0;
      font-weight: 800;
      color: #0f172a;
    }

    .chip {
      background: #eef2ff;
      color: #3730a3;
      font-weight: 700;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: .85rem;
      white-space: nowrap;
    }

    .chip.gray { background:#f3f4f6; color:#111827; }
    .chip.green{ background:#dcfce7; color:#065f46; }
    .chip.yellow{ background:#fff7ed; color:#92400e; }
    .chip.red   { background:#fee2e2; color:#991b1b; }

    @media (max-width: 768px) {
      .server-head {
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .server-head > .flex-grow-1 {
        flex-basis: 100%;
      }
    }

    /* ===== TABELA INTERNA ===== */
    .table-responsive {
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 10px 24px rgba(15,23,42,0.08);
      background-color: #ffffff;
      margin-top: 8px;
      margin-bottom: 0;
    }

    .table thead th {
      background: linear-gradient(to right, #eff6ff, #e0ecff);
      color: #0f172a;
      font-weight: 800;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      text-align: center;
      font-size: 0.86rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .table td {
      text-align: center;
      font-size: 0.88rem;
    }

    .table td, .table th {
      vertical-align: middle;
      padding: 9px 10px;
    }

    .table-hover tbody tr:hover {
      background: #f7fbff;
    }

    .td-actions {
      min-width: 280px;
    }

    @media (max-width: 640px) {
      .td-actions {
        min-width: 260px;
      }
    }

    .badge-status {
      font-weight: 700;
      padding: .45rem .6rem;
      border-radius: 999px;
      display: inline-block;
    }

    .status-pendente   { background:#fff3cd; color:#856404; }
    .status-deferida   { background:#d1fae5; color:#065f46; }
    .status-indeferida { background:#fee2e2; color:#991b1b; }

    .empty-state {
      padding: 24px 16px;
      color: #6b7280;
      text-align: center;
    }

    /* ===== TOTAIS POR SERVIDOR ===== */
    .totals {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #eef2f7;
      background: #fafbfc;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
    }

    .sum-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: .45rem .7rem;
      border-radius: 999px;
      font-size: 0.82rem;
    }

    .sum-chip i {
      font-size: 0.9rem;
    }

    .sum-chip.green  { background:#dcfce7; color:#065f46; }
    .sum-chip.yellow { background:#fff7ed; color:#92400e; }

    /* ===== TEXTO QUANDO NÃO HÁ DADOS ===== */
    .no-data {
      margin-top: 6px;
      padding: 12px 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f9fafb, #e5edff);
      border: 1px dashed var(--primary-soft);
      color: var(--text-muted);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .no-data i {
      color: var(--primary);
    }

    /* ===== FOOTER ===== */
    footer {
      background: linear-gradient(to right, #222, #444);
      color: #ddd;
      text-align: center;
      padding: 15px 0;
      font-size: 14px;
      border-top: 2px solid #555;
      box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
      width: 100%;
    }

    footer p {
      margin: 5px 0;
      font-size: 15px;
      font-weight: 300;
    }

    footer a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease-in-out;
    }

    footer a:hover {
      color: #00aaff;
    }
  </style>
</head>
<body>

  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-center-text-container">
      <div class="header-center-text">PORTAL DO SERVIDOR</div>
    </div>
    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <main>
    <div class="shell">

      <!-- Header card da página -->
      <div class="page-header-card">
        <div class="page-header-icon">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="page-header-content">
          <p class="page-header-title">TREs por Servidor</p>
          <p class="page-header-subtitle">
            Analise as solicitações de TRE agrupadas por servidor, filtre por status e
            registre as decisões diretamente pelo painel.
          </p>
        </div>
      </div>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash {{ category }}">
                {% if category == 'success' %}
                  <i class="fas fa-check-circle"></i>
                {% elif category in ['error', 'danger'] %}
                  <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                  <i class="fas fa-info-circle"></i>
                {% endif %}
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Card de filtros -->
      <div class="content-card filter-card">
        <h2 class="content-title">
          <i class="fas fa-filter"></i>
          Filtros de pesquisa
        </h2>
        <p class="content-subtitle">
          Ajuste o status e utilize a busca para localizar rapidamente os servidores com TREs
          pendentes, deferidas ou indeferidas.
        </p>

        <form class="filter-form" method="get" action="{{ url_for('admin_tres_list') }}">
          <div class="filter-grid">
            <div>
              <label class="small text-muted d-block mb-1">Status</label>
              <select name="status" class="form-control">
                <option value="">Todos</option>
                <option value="pendente"   {{ 'selected' if status=='pendente'  else '' }}>Pendentes</option>
                <option value="deferida"   {{ 'selected' if status=='deferida'  else '' }}>Deferidas</option>
                <option value="indeferida" {{ 'selected' if status=='indeferida' else '' }}>Indeferidas</option>
              </select>
            </div>

            <div>
              <label class="small text-muted d-block mb-1">Buscar</label>
              <div class="search-input">
                <i class="fas fa-search"></i>
                <input
                  type="text"
                  name="q"
                  value="{{ request.args.get('q','') }}"
                  class="form-control"
                  placeholder="Nome ou registro do servidor"
                >
              </div>
            </div>

            <div class="d-flex align-items-end">
              <button class="btn btn-filter btn-block" type="submit">
                <i class="fas fa-filter mr-1"></i> Filtrar
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Card principal com lista agrupada -->
      <div class="content-card">
        <h2 class="content-title">
          <i class="fas fa-users-cog"></i>
          TREs agrupadas por servidor
        </h2>
        <p class="content-subtitle">
          Cada card abaixo representa um servidor e reúne todas as TREs vinculadas a ele.
          Use os botões para deferir, indeferir ou excluir registros conforme necessidade.
        </p>

        {% if tres and tres|length > 0 %}
          <div id="accordionServidores">
            {% for _group in tres|groupby('funcionario_id') %}
              {% set itens = _group.list %}
              {% set first = itens[0] %}

              {# Contagens e somatórios de dias #}
              {% set c = namespace(total=itens|length, pend=0, def_=0, ind=0, pend_days=0, def_days=0) %}
              {% for x in itens %}
                {% set st = (x.status or '')|lower|trim %}
                {% if st == 'pendente' %}
                  {% set c.pend = c.pend + 1 %}
                  {% set c.pend_days = c.pend_days + (x.dias_folga or 0) %}
                {% elif st == 'deferida' %}
                  {% set c.def_ = c.def_ + 1 %}
                  {% set c.def_days = c.def_days + ((x.dias_validados if x.dias_validados is not none else x.dias_folga) or 0) %}
                {% elif st == 'indeferida' %}
                  {% set c.ind = c.ind + 1 %}
                {% endif %}
              {% endfor %}

              <div class="server-card">
                <div class="server-head" data-toggle="collapse" data-target="#c{{ first.funcionario_id }}" aria-expanded="true">
                  <i class="fas fa-user-circle text-secondary fa-lg"></i>
                  <div class="flex-grow-1">
                    <h5 class="server-name mb-0">{{ first.funcionario.nome }}</h5>
                    <small class="text-muted">Registro: {{ first.funcionario.registro }}</small>
                  </div>
                  <span class="chip gray"   title="Total de TREs">Total: {{ c.total }}</span>
                  <span class="chip yellow" title="Pendentes">Pend.: {{ c.pend }}</span>
                  <span class="chip green"  title="Deferidas">Def.: {{ c.def_ }}</span>
                  <span class="chip red"    title="Indeferidas">Ind.: {{ c.ind }}</span>
                  <i class="fas fa-chevron-down ml-2 text-muted"></i>
                </div>

                <div id="c{{ first.funcionario_id }}" class="collapse show" data-parent="#accordionServidores">
                  <div class="p-2">
                    <div class="table-responsive">
                      <table class="table table-hover mb-0">
                        <thead>
                          <tr>
                            <th style="width:70px;">#</th>
                            <th>Dias (solicit.)</th>
                            <th>Status</th>
                            <th>Enviado em</th>
                            <th>Arquivo</th>
                            <th class="td-actions">Ações</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for t in itens|sort(attribute='id', reverse=True) %}
                            <tr id="row-{{ t.id }}">
                              <td><strong>{{ t.id }}</strong></td>
                              <td>{{ t.dias_folga }}</td>
                              <td>
                                <span class="badge-status
                                  {% if (t.status or '')|lower|trim == 'pendente' %}
                                    status-pendente
                                  {% elif (t.status or '')|lower|trim == 'deferida' %}
                                    status-deferida
                                  {% else %}
                                    status-indeferida
                                  {% endif %}">
                                  {{ (t.status or '')|title }}
                                </span>
                                {% if t.dias_validados %}
                                  <small class="text-muted d-block">val.: {{ t.dias_validados }} dia(s)</small>
                                {% endif %}
                              </td>
                              <td>{{ t.data_envio.strftime("%d/%m/%Y %H:%M") if t.data_envio else '-' }}</td>
                              <td>
                                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('download_tre', tre_id=t.id) }}">
                                  <i class="fas fa-download"></i> PDF
                                </a>
                              </td>
                              <td>
                                {% if (t.status or '')|lower|trim == 'pendente' %}
                                  <button
                                    class="btn btn-sm btn-success mb-1"
                                    data-toggle="modal"
                                    data-target="#modalDecidir"
                                    data-id="{{ t.id }}"
                                    data-dias="{{ t.dias_folga }}"
                                    data-acao="aprovar"
                                  >
                                    <i class="fas fa-check"></i> Deferir
                                  </button>
                                  <button
                                    class="btn btn-sm btn-warning mb-1 text-white"
                                    data-toggle="modal"
                                    data-target="#modalDecidir"
                                    data-id="{{ t.id }}"
                                    data-dias="{{ t.dias_folga }}"
                                    data-acao="indeferir"
                                  >
                                    <i class="fas fa-times"></i> Indeferir
                                  </button>
                                {% else %}
                                  <em class="text-muted mr-2">—</em>
                                {% endif %}

                                <button
                                  class="btn btn-sm btn-outline-danger mb-1 btn-open-delete"
                                  data-id="{{ t.id }}"
                                >
                                  <i class="fas fa-trash-alt"></i> Excluir
                                </button>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Totais de dias para o servidor -->
                  <div class="totals">
                    <span class="sum-chip green">
                      <i class="fas fa-check-circle"></i>
                      Total deferido: <strong>{{ c.def_days }}</strong> dia(s)
                    </span>
                    <span class="sum-chip yellow">
                      <i class="fas fa-hourglass-half"></i>
                      Total pendente: <strong>{{ c.pend_days }}</strong> dia(s)
                    </span>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="no-data">
            <i class="fas fa-info-circle"></i>
            <span>Nenhum registro de TRE encontrado para os filtros aplicados.</span>
          </div>
        {% endif %}
      </div>

    </div>
  </main>

  <!-- Rodapé -->
  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <!-- Modal decidir -->
  <div class="modal fade" id="modalDecidir" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="formDecidir" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><span id="acaoTitulo">Deferir</span> TRE</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="treId">
          <input type="hidden" id="treAcao">
          <div class="form-group">
            <label>Dias validados (pode ajustar)</label>
            <input type="number" id="diasValidados" class="form-control" min="1" step="1">
            <small class="form-text text-muted">Se ficar vazio, usaremos o valor solicitado.</small>
          </div>
          <div class="form-group">
            <label>Parecer (opcional)</label>
            <textarea id="parecer" class="form-control" rows="3" placeholder="Observações para o servidor"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" type="submit">Confirmar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal excluir -->
  <div class="modal fade" id="modalExcluir" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white" style="border-top-left-radius:16px;border-top-right-radius:16px;">
          <h5 class="modal-title"><i class="fas fa-trash-alt mr-1"></i> Excluir TRE</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="delTreId">
          <p>Tem certeza que deseja <strong>excluir definitivamente</strong> esta TRE? Esta ação não poderá ser desfeita.</p>
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i>
            A exclusão é permitida para qualquer status (pendente, deferida ou indeferida).
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger" id="btnConfirmDelete">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

  <script>
    // Preenche modal de decisão
    $('#modalDecidir').on('show.bs.modal', function (e) {
      var btn = $(e.relatedTarget);
      var id = btn.data('id');
      var acao = btn.data('acao');
      var dias = btn.data('dias');

      $('#treId').val(id);
      $('#treAcao').val(acao);
      $('#acaoTitulo').text(acao === 'aprovar' ? 'Deferir' : 'Indeferir');
      $('#diasValidados').val(dias);
      $('#parecer').val('');
    });

    // Submete decisão
    $('#formDecidir').on('submit', function(e){
      e.preventDefault();
      var id = $('#treId').val();
      var acao = $('#treAcao').val();
      var dias = $('#diasValidados').val();
      var parecer = $('#parecer').val();

      fetch(`/admin/tre/${id}/decidir`, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          acao: acao,
          dias_validados: dias,
          parecer_admin: parecer
        })
      }).then(r=>r.json()).then(data=>{
        if(data.success){ location.reload(); }
        else{ alert(data.error || 'Erro ao processar.'); }
      }).catch(()=>alert('Erro de rede.'));
    });

    // Abrir modal de exclusão
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.btn-open-delete');
      if(!btn) return;
      var id = btn.getAttribute('data-id');
      document.getElementById('delTreId').value = id;
      $('#modalExcluir').modal('show');
    });

    // Confirmar exclusão
    document.getElementById('btnConfirmDelete').addEventListener('click', function(){
      var id = document.getElementById('delTreId').value;
      fetch(`/admin/tre/${id}/excluir`, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({})
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          var row = document.getElementById(`row-${id}`);
          if(row) row.parentNode.removeChild(row);
          $('#modalExcluir').modal('hide');
        }else{
          alert(data.error || 'Não foi possível excluir.');
        }
      }).catch(()=>alert('Erro de rede.'));
    });
  </script>
</body>
</html>
