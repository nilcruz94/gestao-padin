<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Relatório de Horas Extras - E.M José Padin Mouta</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=3, minimum-scale=1" />
  <!-- CSRF para eventuais requisições (AJAX/futuros formulários) -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #0051ff;
      --primary-soft: #dbe9ff;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --warning: #f59e0b;
      --warning-soft: #fef3c7;
      --danger: #dc2626;
      --danger-soft: #fee2e2;

      --card-shadow: 0 14px 34px rgba(15,23,42,.1), 0 2px 4px rgba(15,23,42,.06);
      --radius: 18px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at top, #e0f2ff 0, #f9fafb 45%, #eef2ff 100%);
      background-attachment: fixed;
      color: var(--text-main);
    }

    body { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1 0 auto; padding: 24px 12px 60px; box-sizing: border-box; }
    .shell { width: 100%; max-width: 980px; margin: 0 auto; }
    @media (min-width: 769px) { main { padding: 30px 24px 80px; } }

    /* ===== Cabeçalhos ===== */
    .header-desktop, .header-mobile { display: none; flex-shrink: 0; }

    @media (min-width: 769px) {
      .header-desktop {
        display: flex; background-color: #007bff; padding: 15px 30px; width: 100%;
        align-items: center; justify-content: space-between; box-sizing: border-box;
        min-height: 110px; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,.15); color: #fff;
      }
      .left-section { display: flex; align-items: center; gap: 20px; }
      .logo { width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background:#fff; padding:6px; }
      .text-container { display:flex; flex-direction:column; justify-content:center; text-align:left; color:#fff; }
      .escola-nome { font-weight: 700; font-size: 1.6rem; margin: 0; line-height: 1.1; }
      .escola-subtitulo { font-weight: 600; font-size: 1.1rem; margin-top: 4px; }
      .header-center-text-container {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
        font-weight: 800; font-size: 1.9rem; color: #fff; letter-spacing: 5px; user-select: none; white-space: nowrap; z-index: 1;
        text-shadow: 0 2px 5px rgba(0,0,0,.3);
      }
      .header-center-text { font-family: 'Montserrat', sans-serif; }
      .btn-home {
        background: #0fb300; color: #fff; padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 1.5rem;
        text-decoration: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 6px rgba(15,179,0,.8);
        transition: .3s background-color; position: absolute; right: 30px; top: 50%; transform: translateY(-50%); z-index: 2;
      }
      .btn-home:hover { background: #0d8a00; }
    }

    @media (max-width: 768px) {
      .header-mobile {
        display:block; width:100%; box-sizing:border-box; color:#fff; position:sticky; top:0; z-index:1000;
        box-shadow:0 2px 6px rgba(0,0,0,.15); background:#007bff;
      }
      .header-top { display:flex; align-items:center; justify-content:center; gap:15px; padding:10px 15px; background:#007bff; }
      .logo { width:48px; height:48px; object-fit:contain; border-radius:10px; background:#fff; padding:6px; }
      .text-container { display:flex; flex-direction:column; justify-content:center; color:#fff; text-align:center; }
      .escola-nome { font-weight:700; font-size:1.3rem; margin:0; line-height:1.1; }
      .escola-subtitulo { font-weight:600; font-size:1rem; margin-top:2px; }
      .header-bottom {
        background:#0056b3; text-align:center; padding:12px 10px; font-weight:800; font-size:1rem; letter-spacing:4px; user-select:none;
        color:#fff; box-shadow: inset 0 -2px 5px rgba(0,0,0,.2); display:flex; justify-content:center; align-items:center; gap:12px; white-space:nowrap;
      }
      .btn-home-mobile {
        background:#0fb300; color:#fff; padding:6px 10px; border-radius:6px; font-weight:600; font-size:1rem; text-decoration:none;
        display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(15,179,0,.8); transition:.3s background-color;
      }
      .btn-home-mobile:hover { background:#0d8a00; }
    }

    /* ===== Header card ===== */
    .page-header-card {
      background:#fff; border-radius:var(--radius); padding:16px 18px; margin:0 auto 18px; display:flex; align-items:center; gap:16px;
      box-shadow: var(--card-shadow); border-left: 5px solid var(--primary);
    }
    .page-header-icon {
      display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #e0edff 60%, #c7d9ff 100%);
      box-shadow: 0 4px 12px rgba(37,99,235,.45); color:#2563eb;
    }
    .page-header-icon i { font-size:22px; }
    .page-header-title { font-size:1.15rem; font-weight:800; margin:0; color:var(--text-main); }
    .page-header-subtitle { font-size:.9rem; margin:0; color:var(--text-muted); }
    @media (max-width: 600px) {
      .page-header-card { padding:12px 14px; }
      .page-header-title { font-size:1.05rem; }
      .page-header-subtitle { font-size:.82rem; }
    }

    /* ===== Card principal ===== */
    .content-card {
      width:100%; margin:0 auto 30px; background:var(--surface); border-radius:16px;
      box-shadow:0 18px 40px rgba(15,23,42,.12); padding:18px 18px 22px;
      border:1px solid rgba(148,163,184,.35); backdrop-filter: blur(8px);
    }
    .content-title { font-size:1.05rem; font-weight:700; margin:0 0 6px; color:var(--text-main); display:flex; align-items:center; gap:8px; }
    .content-title i { color: var(--primary); }
    .content-subtitle { font-size:.88rem; color:var(--text-muted); margin:0 0 16px; }

    /* ===== Busca ===== */
    .search-container { width:100%; margin-bottom:16px; }
    .search-input-wrapper { position:relative; display:flex; align-items:center; }
    .search-input-wrapper i { position:absolute; left:12px; font-size:.9rem; color:var(--text-muted); }
    .search-container input {
      width:100%; padding:9px 10px 9px 32px; font-size:.9rem; border-radius:999px; border:1px solid var(--border-soft);
      background:#f9fafb; outline:none; transition:.15s border-color, .15s box-shadow, .15s background-color; font-family:'Montserrat', sans-serif;
    }
    .search-container input:focus { background:#fff; border-color:var(--primary); box-shadow:0 0 0 2px rgba(37,99,235,.18); }

    /* ===== Tabela ===== */
    .table-card { margin-top: 4px; }
    .table-container { overflow-x:auto; border-radius:12px; border:1px solid var(--border-soft); box-shadow:0 10px 24px rgba(15,23,42,.08); background:#fff; }
    table { width:100%; border-collapse:collapse; font-size:.9rem; }
    thead { background: linear-gradient(to right, #eff6ff, #e0ecff); }
    th, td {
      padding:9px 10px;
      border-bottom:1px solid #e5e7eb;
      text-align:center;            /* CENTRALIZAÇÃO GLOBAL */
      vertical-align:middle;
    }
    th { font-weight:700; color:#1f2933; font-size:.86rem; text-transform:uppercase; letter-spacing:.04em; }
    tbody tr:nth-child(even) { background:#f9fafb; }
    tbody tr:hover { background:#eef2ff; }
    td.hours-cell { font-weight:600; color:var(--primary-dark); white-space:nowrap; }

    /* Detalhes (linha expansível) */
    .details-row { background:#f8fafc; }
    .details-wrapper { padding: 12px 6px 8px; }

    /* métricas (cadastradas/usufruídas/saldo) */
    .metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 2px 0 14px;
    }
    @media (max-width: 640px) { .metrics { grid-template-columns: 1fr; } }

    .metric {
      background: #fff;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      box-shadow: 0 6px 14px rgba(15,23,42,.08);
      padding: 12px 14px;
      text-align: center;           /* Centraliza valores das métricas */
    }
    .metric .label {
      font-size: .78rem;
      color: var(--text-muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin-bottom: 6px;
      display: block;
    }
    .metric .value {
      font-size: 1.15rem;
      font-weight: 800;
      color: var(--text-main);
    }

    .details-block-title {
      font-size: .94rem;
      font-weight: 800;
      margin: 8px 2px 8px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .details-block-title i { color: var(--primary); }

    .subtable { width:100%; border-collapse: collapse; font-size:.88rem; }
    .subtable th, .subtable td {
      padding:8px 8px;
      border-bottom:1px dashed #e5e7eb;
      text-align: center;           /* CENTRALIZAÇÃO EM TODAS AS SUBTABELAS */
      vertical-align: middle;
    }
    .subtable th { background:#f3f4f6; font-size:.78rem; letter-spacing:.03em; }
    .subtable tr:hover { background: #f1f5f9; }
    .empty { text-align:center; color:var(--text-muted); font-style:italic; padding:10px 0; }

    .btn-details {
      padding:6px 10px; border-radius:999px; border:1px solid var(--primary); background:#fff; color: var(--primary);
      cursor:pointer; font-size:.82rem; font-weight:700; display:inline-flex; align-items:center; gap:8px;
      transition:.15s background-color, .15s color, .15s box-shadow, .1s transform;
    }
    .btn-details:hover { background:var(--primary); color:#fff; box-shadow:0 4px 10px rgba(37,99,235,.4); transform: translateY(-1px); }
    .btn-details i { font-size:.9rem; }

    /* Status badge */
    .status-badge { display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-weight:700; font-size:.78rem; border:1px solid transparent; white-space:nowrap; }
    .status-deferido { background:var(--success-soft); color:#166534; border-color:#bbf7d0; }
    .status-aguardo  { background:var(--warning-soft); color:#92400e; border-color:#facc15; }
    .status-indeferido { background:var(--danger-soft); color:#b91c1c; border-color:#fecaca; }

    /* ===== Paginação ===== */
    .pagination { display:flex; justify-content:center; align-items:center; gap:6px; flex-wrap:wrap; margin-top:14px; }
    .pagination button {
      border:1px solid var(--primary); background:#fff; color: var(--primary); padding:5px 11px; border-radius:999px;
      cursor:pointer; font-size:.82rem; font-family:'Montserrat', sans-serif; font-weight:600;
      transition:.15s background-color, .15s color, .15s box-shadow, .1s transform;
    }
    .pagination button:hover:not(.active):not(:disabled) { background:var(--primary); color:#fff; box-shadow:0 4px 10px rgba(37,99,235,.4); transform: translateY(-1px); }
    .pagination button.active { background:var(--primary); color:#fff; font-weight:700; box-shadow:0 4px 10px rgba(37,99,235,.4); }
    .pagination button:disabled { opacity:.45; cursor:default; box-shadow:none; transform:none; }
    .pagination span { font-size:.82rem; color:var(--text-muted); user-select:none; }

    /* ===== Rodapé ===== */
    footer {
      background: linear-gradient(to right, #222, #444); color:#ddd; text-align:center; padding:15px 0; font-size:14px;
      border-top:2px solid #555; box-shadow:0 -2px 10px rgba(0,0,0,.3); flex-shrink:0; width:100%;
    }
    footer p { margin:5px 0; font-size:15px; font-weight:300; }
    footer a { color:#fff; text-decoration:none; font-weight:500; transition:.3s color; }
    footer a:hover { color:#00aaff; }
  </style>
</head>
<body>

  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-center-text-container">
      <div class="header-center-text">PORTAL DO SERVIDOR</div>
    </div>
    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <!-- Conteúdo principal -->
  <main>
    <div class="shell">

      <!-- Header card da página -->
      <div class="page-header-card">
        <div class="page-header-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="page-header-content">
          <p class="page-header-title">Relatório de Horas Extras</p>
          <p class="page-header-subtitle">
            Consulte o total disponível por servidor, os registros detalhados (data e motivo) e as horas usufruídas via agendamento BH.
          </p>
        </div>
      </div>

      <!-- Card principal -->
      <div class="content-card">
        <h2 class="content-title">
          <i class="fas fa-user-clock"></i>
          Servidores com banco de horas disponível
        </h2>
        <p class="content-subtitle">
          Use o campo abaixo para localizar rapidamente um servidor pelo nome. Os resultados são exibidos em páginas de até 10 servidores.
        </p>

        <div class="search-container">
          <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Digite um nome para filtrar..." />
          </div>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="usuariosTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Registro</th>
                  <th>Email</th>
                  <th>Total Disponível</th>
                  <th style="width: 1%; white-space: nowrap;">Detalhes</th>
                </tr>
              </thead>
              <tbody>
                {# 'usuarios' deve conter: id, nome, registro, email, horas, minutos, registros (lista), total_cadastradas_min, total_usufruidas_min, agendamentos_bh (lista) #}
                {% for usuario in usuarios %}
                  <tr class="user-row" data-user-id="{{ usuario.id }}">
                    <td class="col-nome">{{ usuario.nome }}</td>
                    <td>{{ usuario.registro }}</td>
                    <td>{{ usuario.email }}</td>
                    <td class="hours-cell">{{ usuario.horas }}h {{ "%02d"|format(usuario.minutos|default(0)) }}m</td>
                    <td>
                      <button class="btn-details" type="button" onclick="toggleDetails({{ usuario.id }}, this)">
                        <i class="fas fa-chevron-down"></i> Ver detalhes
                      </button>
                    </td>
                  </tr>
                  <tr class="details-row" data-user-id="{{ usuario.id }}" style="display:none;">
                    <td colspan="5">
                      <div class="details-wrapper">

                        {# ================= RESUMO: Cadastradas / Usufruídas / Saldo ================= #}
                        {% set cad_min = usuario.total_cadastradas_min|default(0) %}
                        {% set usu_min = usuario.total_usufruidas_min|default(0) %}
                        {% set sal_min = cad_min - usu_min %}
                        <div class="metrics">
                          <div class="metric">
                            <span class="label">Horas cadastradas</span>
                            <div class="value">
                              {{ (cad_min // 60) }}h {{ "%02d"|format(cad_min % 60) }}m
                            </div>
                          </div>
                          <div class="metric">
                            <span class="label">Horas usufruídas</span>
                            <div class="value">
                              {{ (usu_min // 60) }}h {{ "%02d"|format(usu_min % 60) }}m
                            </div>
                          </div>
                          <div class="metric">
                            <span class="label">Saldo</span>
                            <div class="value">
                              {{ (sal_min // 60) }}h {{ "%02d"|format(sal_min % 60) }}m
                            </div>
                          </div>
                        </div>

                        {# ================= REGISTROS DE BANCO DE HORAS (CADASTRADAS) ================= #}
                        <div class="details-block-title">
                          <i class="fas fa-clipboard-list"></i> Registros de Banco de Horas
                        </div>
                        <table class="subtable">
                          <thead>
                            <tr>
                              <th style="width: 120px;">Data</th>
                              <th>Motivo</th>
                              <th style="width: 120px;">Quantidade</th>
                              <th style="width: 140px;">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% if usuario.registros and usuario.registros|length > 0 %}
                              {% for r in usuario.registros|sort(attribute='data_realizacao', reverse=True) %}
                                <tr>
                                  <td>
                                    {% if r.data_realizacao %}
                                      {{ r.data_realizacao.strftime('%d/%m/%Y') }}
                                    {% else %}-{% endif %}
                                  </td>
                                  <td>{{ r.motivo or '-' }}</td>
                                  <td>{{ r.horas|default(0) }}h {{ "%02d"|format(r.minutos|default(0)) }}m</td>
                                  <td>
                                    {% set _raw = (r.status_label if r.status_label is defined else r.status) | default('') %}
                                    {% set _s = _raw|default('')|lower|trim %}
                                    {% if 'deferid' in _s or _s in ['aprovado','aprovada'] %}
                                      <span class="status-badge status-deferido"><i class="fas fa-check-circle"></i> Deferido</span>
                                    {% elif 'indeferid' in _s or _s in ['rejeitado','rejeitada','negado','negada'] %}
                                      <span class="status-badge status-indeferido"><i class="fas fa-times-circle"></i> Indeferido</span>
                                    {% elif 'serem deferidas' in _s or 'serem deferidos' in _s or 'deferir' in _s
                                           or 'anal' in _s or 'espera' in _s or 'aguard' in _s or 'pendent' in _s %}
                                      <span class="status-badge status-aguardo"><i class="fas fa-hourglass-half"></i> Em análise</span>
                                    {% else %}
                                      <span class="status-badge status-aguardo"><i class="fas fa-hourglass-half"></i> Em análise</span>
                                    {% endif %}
                                  </td>
                                </tr>
                              {% endfor %}
                            {% else %}
                              <tr><td colspan="4" class="empty">Nenhum registro de banco de horas encontrado.</td></tr>
                            {% endif %}
                          </tbody>
                        </table>

                        {# ================= USUFRUTO BH (AGENDAMENTOS motivo='BH') ================= #}
                        <div class="details-block-title" style="margin-top:14px;">
                          <i class="fas fa-hourglass-end"></i> Agendamentos BH (Horas usufruídas)
                        </div>
                        <table class="subtable">
                          <thead>
                            <tr>
                              <th style="width: 120px;">Data</th>
                              <th style="width: 140px;">Quantidade</th>
                              <th style="width: 160px;">Data de Referência</th>
                              <th style="width: 140px;">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% if usuario.agendamentos_bh and usuario.agendamentos_bh|length > 0 %}
                              {% for a in usuario.agendamentos_bh|sort(attribute='data', reverse=True) %}
                                <tr>
                                  <td>
                                    {% if a.data %}{{ a.data.strftime('%d/%m/%Y') }}{% else %}-{% endif %}
                                  </td>
                                  <td>{{ a.horas|default(0) }}h {{ "%02d"|format(a.minutos|default(0)) }}m</td>
                                  <td>
                                    {% if a.data_referencia %}{{ a.data_referencia.strftime('%d/%m/%Y') }}{% else %}-{% endif %}
                                  </td>
                                  <td>
                                    {% set raw = (a.status_label if a.status_label is defined else a.status) | default('') %}
                                    {% set st = raw|default('')|lower|trim %}
                                    {% if 'deferid' in st or st in ['aprovado','aprovada'] %}
                                      <span class="status-badge status-deferido"><i class="fas fa-check-circle"></i> Deferido</span>
                                    {% elif 'indeferid' in st or st in ['rejeitado','rejeitada','negado','negada'] %}
                                      <span class="status-badge status-indeferido"><i class="fas fa-times-circle"></i> Indeferido</span>
                                    {% elif 'anal' in st or 'espera' in st or 'aguard' in st or 'pendent' in st %}
                                      <span class="status-badge status-aguardo"><i class="fas fa-hourglass-half"></i> Em análise</span>
                                    {% else %}
                                      <span class="status-badge status-aguardo"><i class="fas fa-hourglass-half"></i> Em análise</span>
                                    {% endif %}
                                  </td>
                                </tr>
                              {% endfor %}
                            {% else %}
                              <tr><td colspan="4" class="empty">Nenhum agendamento BH encontrado.</td></tr>
                            {% endif %}
                          </tbody>
                        </table>

                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Paginação -->
        <div id="pagination" class="pagination"></div>
      </div>

    </div>
  </main>

  <!-- Rodapé -->
  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <script>
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('usuariosTable');
    const tbody = table.querySelector('tbody');

    // Linhas-resumo (uma por servidor) e mapa para suas linhas de detalhes
    const allSummaryRows = Array.from(tbody.querySelectorAll('tr.user-row'));
    const detailsRowsMap = {};
    allSummaryRows.forEach(row => {
      const id = row.getAttribute('data-user-id');
      const details = tbody.querySelector(`tr.details-row[data-user-id="${id}"]`);
      detailsRowsMap[id] = details;
    });

    const rowsPerPage = 10;
    let filteredSummaryRows = [...allSummaryRows];
    let currentPage = 1;

    function toggleDetails(id, btn) {
      const details = detailsRowsMap[id];
      if (!details) return;
      const visible = details.style.display !== 'none';
      details.style.display = visible ? 'none' : '';
      if (btn) {
        const icon = btn.querySelector('i');
        if (icon) icon.className = visible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        btn.innerHTML = btn.innerHTML.replace(visible ? 'Ocultar detalhes' : 'Ver detalhes',
                                              visible ? 'Ver detalhes' : 'Ocultar detalhes');
      }
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      const total = filteredSummaryRows.length;
      const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));

      const prevBtn = document.createElement('button');
      prevBtn.textContent = '«';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });
      pagination.appendChild(prevBtn);

      for (let p = 1; p <= totalPages; p++) {
        if (p === 1 || p === totalPages || (p >= currentPage - 2 && p <= currentPage + 2)) {
          const btn = document.createElement('button');
          btn.textContent = p;
          if (p === currentPage) btn.classList.add('active');
          btn.addEventListener('click', () => {
            currentPage = p;
            renderTable();
          });
          pagination.appendChild(btn);
        } else if (p === currentPage - 3 || p === currentPage + 3) {
          const span = document.createElement('span');
          span.textContent = '...';
          pagination.appendChild(span);
        }
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = '»';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });
      pagination.appendChild(nextBtn);
    }

    function renderTable() {
      // Esconde tudo inicialmente
      allSummaryRows.forEach(row => row.style.display = 'none');
      Object.values(detailsRowsMap).forEach(row => { if (row) row.style.display = 'none'; });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageRows = filteredSummaryRows.slice(start, end);

      // Mostra apenas os servidores da página atual; mantém detalhes fechados por padrão
      pageRows.forEach(row => {
        row.style.display = '';
        const id = row.getAttribute('data-user-id');
        const btn = row.querySelector('.btn-details');
        if (btn) {
          const icon = btn.querySelector('i');
          if (icon) icon.className = 'fas fa-chevron-down';
          btn.innerHTML = btn.innerHTML.replace('Ocultar detalhes', 'Ver detalhes');
        }
      });

      renderPagination();
    }

    function applyFilter() {
      const filter = (searchInput.value || '').trim().toLowerCase();

      if (!filter) {
        filteredSummaryRows = [...allSummaryRows];
      } else {
        filteredSummaryRows = allSummaryRows.filter(row => {
          const nameCell = row.querySelector('.col-nome');
          const textValue = (nameCell?.textContent || nameCell?.innerText || '').toLowerCase();
          return textValue.includes(filter);
        });
      }

      currentPage = 1;
      renderTable();
    }

    searchInput.addEventListener('keyup', applyFilter);

    /* ====== Normalização de nomes (Title Case “inteligente”) ======
       - Primeira e última palavras sempre em maiúscula inicial
       - Preposições/artigos comuns em minúsculas (quando no meio)
       - Suporte básico a nomes hifenizados
    */
    function smartTitleCase(str) {
      if (!str) return str;
      const lowers = new Set(['da','de','do','das','dos','e','em','no','na','nos','nas','para','por','com','del','di','du','la','le','van','von']);
      const words = str
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim()
        .split(' ');

      return words.map((w, idx) => {
        const first = idx === 0, last = idx === words.length - 1;
        const parts = w.split('-').map(p => {
          if (!p) return p;
          const keepLower = !first && !last && lowers.has(p);
          if (keepLower) return p;
          return p.charAt(0).toUpperCase() + p.slice(1);
        });
        let out = parts.join('-');
        if (!first && !last && lowers.has(w)) out = w;
        return out;
      }).join(' ');
    }

    function normalizeAllNames() {
      document.querySelectorAll('.col-nome').forEach(td => {
        td.textContent = smartTitleCase(td.textContent || '');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      normalizeAllNames();
      applyFilter();
    });
  </script>
</body>
</html>
