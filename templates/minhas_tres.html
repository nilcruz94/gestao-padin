<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minhas TREs</title>

  <!-- CSRF -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg:#f3f4f6;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#0d6efd;
      --brand-soft:#e0edff;
      --border-soft:#e5e7eb;
      --card-shadow:0 14px 34px rgba(15,23,42,.08), 0 2px 4px rgba(15,23,42,.05);
      --radius:18px;
    }

    *, *::before, *::after{ box-sizing:border-box; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: var(--bg);
      color: var(--ink);
      font-family: 'Montserrat', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    body { overflow-y:auto; }

    main {
      flex: 1 0 auto;
      padding: 24px 12px 70px;
    }

    .shell{ max-width: 1100px; margin:0 auto; }

    @media (min-width:769px){
      main{ padding:30px 24px 90px; }
    }

    /* Cabeçalhos */
    .header-desktop, .header-mobile { display: none; flex-shrink: 0; }

    /* === Desktop Header === */
    @media (min-width: 769px) {
      .header-desktop {
        display: flex;
        background-color: #007bff;
        padding: 15px 30px;
        width: 100%;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
        min-height: 110px;
        position: relative;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        color: white;
      }

      .left-section { display: flex; align-items: center; gap: 20px; }

      .logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: 10px;
        background-color: white;
        padding: 6px;
      }

      .text-container { display: flex; flex-direction: column; justify-content: center; text-align: left; color: white; }

      .escola-nome { font-weight: 700; font-size: 1.6rem; margin: 0; line-height: 1.1; }

      .escola-subtitulo { font-weight: 600; font-size: 1.1rem; margin-top: 4px; }

      .header-center-text-container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: 800;
        font-size: 1.9rem;
        color: white;
        letter-spacing: 5px;
        user-select: none;
        white-space: nowrap;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }

      .btn-home {
        background-color: #0fb300;
        color: white;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 1.5rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8);
        transition: background-color 0.3s ease;
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
      }

      .btn-home:hover { background-color: #0d8a00; }
    }

    /* === Mobile Header === */
    @media (max-width: 768px) {
      .header-mobile {
        display: block;
        width: 100%;
        box-sizing: border-box;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        background-color: #007bff;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 10px 15px;
        background-color: #007bff;
        text-align: center;
      }

      .logo {
        width: 48px;
        height: 48px;
        object-fit: contain;
        border-radius: 10px;
        background-color: white;
        padding: 6px;
      }

      .text-container { display: flex; flex-direction: column; justify-content: center; color: white; text-align: center; }

      .escola-nome { font-weight: 700; font-size: 1.3rem; margin: 0; line-height: 1.1; }

      .escola-subtitulo { font-weight: 600; font-size: 1rem; margin-top: 2px; }

      .header-bottom {
        background-color: #0056b3;
        text-align: center;
        padding: 12px 10px;
        font-weight: 800;
        font-size: 1.0rem;
        letter-spacing: 4px;
        user-select: none;
        color: white;
        box-shadow: inset 0  -2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        position: relative;
        white-space: nowrap;
      }

      .btn-home-mobile {
        background-color: #0fb300;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(15,179,0,0.8);
        transition: background-color 0.3s ease;
      }

      .btn-home-mobile:hover { background-color: #0d8a00; }
    }

    /* ===== Cabeçalho da página ===== */
    .page-header-card{
      background:#ffffff;
      border-radius:var(--radius);
      padding:16px 18px;
      margin-bottom:18px;
      display:flex;
      align-items:center;
      gap:16px;
      box-shadow:var(--card-shadow);
      border-left:5px solid var(--brand);
    }

    .page-header-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:42px;
      height:42px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#ffffff 0%,var(--brand-soft) 60%,#c7d9ff 100%);
      box-shadow:0 4px 12px rgba(37,99,235,.45);
      color:#2563eb;
      flex-shrink:0;
    }

    .page-header-icon i{ font-size:22px; }

    .page-header-content{ display:flex; flex-direction:column; gap:4px; }

    .page-header-title{
      font-size:1.2rem;
      font-weight:800;
      margin:0;
      color:var(--ink);
    }

    .page-header-subtitle{ font-size:0.9rem; margin:0; color:var(--muted); }

    @media (max-width:600px){
      .page-header-card{ padding:12px 14px; margin-bottom:14px; }
      .page-header-title{ font-size:1.05rem; }
      .page-header-subtitle{ font-size:0.82rem; }
    }

    /* Flash messages */
    .flash-messages { margin-bottom: 14px; }

    .flash {
      padding: 9px 12px;
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 0.86rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 3px 10px rgba(15,23,42,.08);
    }

    .flash.success { background: #e8f7ee; color: #065f46; border:1px solid #b7ebc6; }
    .flash.danger  { background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .flash.warning { background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .flash.info    { background: #e0edff; color: #1d4ed8; border:1px solid #bfdbfe; }

    /* Card principal da lista */
    .agenda-card{
      width:100%;
      background:#ffffff;
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      padding:18px 16px 20px;
      border:1px solid rgba(148,163,184,0.25);
      box-sizing:border-box;
      margin-bottom:18px;
    }

    .agenda-headline{ display:flex; flex-direction:column; gap:4px; margin-bottom:12px; }

    .agenda-title{ font-size:1.05rem; font-weight:800; color:var(--ink); }

    .agenda-subtitle{ font-size:0.86rem; color:var(--muted); }

    @media (min-width:640px){
      .agenda-headline{ flex-direction:row; justify-content:space-between; align-items:center; }
      .agenda-title{ font-size:1.1rem; }
    }

    .no-data { text-align: center; margin-top: 10px; font-size: 0.95rem; color: var(--muted); }

    /* Filtros */
    .filters{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin-bottom:10px;
    }
    @media (min-width:700px){
      .filters{ grid-template-columns: 1fr 1fr 2fr auto; align-items:end; }
    }
    label.small{ font-size:.78rem; color:var(--muted); font-weight:700; display:block; margin-bottom:4px; }
    select, input[type="text"]{
      width:100%; padding:8px 10px; border:1px solid var(--border-soft); border-radius:10px; font-size:.9rem;
      outline:none; background:#fff;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:9px 14px; border-radius:10px; border:1px solid #0d6efd; background:#0d6efd; color:#fff; font-weight:800; cursor:pointer;
    }
    .btn.secondary{ background:#fff; color:#0d6efd; }
    .btn:disabled{ opacity:.6; cursor:default; }

    /* Tabela */
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top:6px; }
    thead th {
      background-color: #f8fafc; color: #0f172a; padding: 8px 6px; font-weight: 800; text-align: center;
      border-bottom:1px solid #e5e7eb; white-space:nowrap;
    }
    tbody td { padding: 8px 6px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #111827; vertical-align: middle; }
    tbody tr:nth-child(even) { background-color: #f9fafb; }
    tbody tr:hover{ background:#f7fbff; }

    /* Status pill */
    .status-pill {
      display: inline-flex; align-items: center; justify-content: center; padding: 2px 10px; border-radius: 999px;
      font-size: 0.8rem; font-weight: 700; white-space: nowrap;
    }
    .status-pill.pendente { background-color: #fef3c7; color: #92400e; }
    .status-pill.deferida { background-color: #d1fae5; color: #065f46; }
    .status-pill.indeferida { background-color: #fee2e2; color: #991b1b; }

    /* Ações */
    .btn-action{
      border:1px solid #0d6efd; color:#0d6efd; background:#fff; border-radius:999px; padding:6px 10px; font-size:.82rem; font-weight:800;
      display:inline-flex; align-items:center; gap:6px; text-decoration:none;
    }
    .btn-action:hover{ background:#0d6efd; color:#fff; }

    /* Paginação */
    .pagination {
      margin-top: 14px; display: flex; justify-content: center; align-items: center; gap: 6px; flex-wrap: wrap;
    }
    .pagination button {
      border: 1px solid #007bff; background-color: #fff; color: #007bff; padding: 4px 9px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;
    }
    .pagination button:hover:not(.active):not(:disabled) { background-color: #007bff; color: #fff; }
    .pagination button.active { background-color: #007bff; color: #fff; font-weight: 700; }
    .pagination button:disabled { opacity: 0.5; cursor: default; }
    .pagination span { font-size: 0.85rem; color: #555; }

    @media (max-width: 768px) {
      thead th, tbody td { font-size: 0.8rem; padding: 6px 4px; }
    }

    /* Rodapé */
    footer {
      background: linear-gradient(to right, #222, #444);
      color: #ddd;
      text-align: center;
      padding: 15px 0;
      font-size: 14px;
      border-top: 2px solid #555;
      box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
      width: 100%;
    }
  </style>
</head>

<script>
  // Expor token CSRF (para fetch/AJAX, se necessário)
  (function () {
    const el = document.querySelector('meta[name="csrf-token"]');
    if (el) window.csrfToken = el.getAttribute('content');
  })();

  document.addEventListener("DOMContentLoaded", function () {
    // Paginação + filtros
    const table = document.getElementById("tresTable");
    const tbody = table ? table.querySelector("tbody") : null;
    const allRows = tbody ? Array.from(tbody.querySelectorAll("tr")) : [];
    const rowsPerPage = 10;
    let currentPage = 1;
    const paginationContainer = document.getElementById("pagination");

    const statusFilter = document.getElementById("statusFilter");
    const ordenacao = document.getElementById("ordenacao");
    const buscaTexto = document.getElementById("buscaTexto");
    const limparBusca = document.getElementById("limparBusca");
    const countVisiveis = document.getElementById("countVisiveis");

    function normalizaData(ddmmyyyyHHMM) {
      // "dd/mm/yyyy hh:mm" -> "yyyy-mm-dd hh:mm" (para comparação)
      if (!ddmmyyyyHHMM) return "";
      const m = ddmmyyyyHHMM.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?/);
      if (!m) return "";
      const d = m[1], M = m[2], y = m[3], hh = m[4] || "00", mm = m[5] || "00";
      return `${y}-${M}-${d} ${hh}:${mm}`;
    }

    function aplicaOrdenacao(rows) {
      const desc = ordenacao && ordenacao.value === "desc";
      rows.sort(function (a, b) {
        const aText = a.getAttribute("data-enviado") || "";
        const bText = b.getAttribute("data-enviado") || "";
        const ka = normalizaData(aText);
        const kb = normalizaData(bText);
        if (ka === kb) {
          const ida = parseInt(a.getAttribute("data-id") || "0", 10);
          const idb = parseInt(b.getAttribute("data-id") || "0", 10);
          return desc ? (idb - ida) : (ida - idb);
        }
        return desc ? kb.localeCompare(ka) : ka.localeCompare(kb);
      });
    }

    function aplicaFiltrosBasicos(row) {
      const st = statusFilter ? statusFilter.value : "todos";
      const q = (buscaTexto ? buscaTexto.value : "").toLowerCase().trim();

      const status = (row.getAttribute("data-status") || "").toLowerCase();
      const haystack = (row.getAttribute("data-busca") || "").toLowerCase();

      const passStatus = (st === "todos" || status === st);
      const passBusca = (!q || haystack.includes(q));

      return (passStatus && passBusca);
    }

    function renderTablePage(page) {
      if (!tbody) return;

      // 1) Ordenar
      const rows = Array.from(allRows);
      aplicaOrdenacao(rows);

      // 2) Filtrar
      const filtradas = rows.filter(aplicaFiltrosBasicos);

      // 3) Paginar
      const totalFiltradas = filtradas.length;
      const totalPages = Math.max(1, Math.ceil(totalFiltradas / rowsPerPage));
      currentPage = Math.min(Math.max(1, page), totalPages);

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      // 4) Aplicar visibilidade
      rows.forEach(r => r.style.display = "none");
      filtradas.slice(start, end).forEach(r => r.style.display = "");

      // 5) Atualizar contagem
      if (countVisiveis) countVisiveis.textContent = totalFiltradas.toString();

      // 6) Render paginador
      renderPaginationControls(totalPages);
    }

    function renderPaginationControls(totalPages) {
      if (!paginationContainer) return;
      paginationContainer.innerHTML = "";

      if (totalPages <= 1) return;

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "«";
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderTablePage(currentPage);
        }
      });
      paginationContainer.appendChild(prevBtn);

      for (let p = 1; p <= totalPages; p++) {
        if (p === 1 || p === totalPages || (p >= currentPage - 2 && p <= currentPage + 2)) {
          const btn = document.createElement("button");
          btn.textContent = p;
          if (p === currentPage) btn.classList.add("active");
          btn.addEventListener("click", () => renderTablePage(p));
          paginationContainer.appendChild(btn);
        } else if (p === currentPage - 3 || p === currentPage + 3) {
          const span = document.createElement("span");
          span.textContent = "...";
          paginationContainer.appendChild(span);
        }
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "»";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          renderTablePage(currentPage);
        }
      });
      paginationContainer.appendChild(nextBtn);
    }

    if (statusFilter) statusFilter.addEventListener("change", () => renderTablePage(1));
    if (ordenacao) ordenacao.addEventListener("change", () => renderTablePage(1));
    if (buscaTexto) buscaTexto.addEventListener("input", () => renderTablePage(1));
    if (limparBusca) limparBusca.addEventListener("click", function(){
      if (buscaTexto) buscaTexto.value = "";
      renderTablePage(1);
    });

    // Inicial
    renderTablePage(1);
  });
</script>

<body>

  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>

    <div class="header-center-text-container">
      PORTAL DO SERVIDOR
    </div>

    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <!-- Conteúdo principal -->
  <main>
    <div class="shell">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash {{ category }}">
                {% if category == 'success' %}
                  <i class="fas fa-check-circle"></i>
                {% elif category in ['danger', 'error'] %}
                  <i class="fas fa-exclamation-circle"></i>
                {% elif category == 'warning' %}
                  <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                  <i class="fas fa-info-circle"></i>
                {% endif %}
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Cabeçalho da página -->
      <div class="page-header-card">
        <div class="page-header-icon">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="page-header-content">
          <p class="page-header-title">Minhas TREs</p>
          <p class="page-header-subtitle">
            Visualize seus envios, status e baixe os PDFs deferidos.
          </p>
        </div>
      </div>

      <!-- Card principal -->
      <div class="agenda-card">
        <div class="agenda-headline">
          <div class="agenda-title">
            TREs de {{ current_user.nome }}
          </div>
          <div class="agenda-subtitle">
            Listadas do mais recente para o mais antigo. Exibindo <span id="countVisiveis">{{ tres|length if tres else 0 }}</span> registro(s).
          </div>
        </div>

        <!-- Filtros -->
        <div class="filters">
          <div>
            <label class="small" for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="todos" selected>Todos</option>
              <option value="pendente">Pendentes</option>
              <option value="deferida">Deferidas</option>
              <option value="indeferida">Indeferidas</option>
            </select>
          </div>
          <div>
            <label class="small" for="ordenacao">Ordenação</label>
            <select id="ordenacao">
              <option value="desc" selected>Mais recentes primeiro</option>
              <option value="asc">Mais antigas primeiro</option>
            </select>
          </div>
          <div>
            <label class="small" for="buscaTexto">Busca (parecer/arquivo)</label>
            <input type="text" id="buscaTexto" placeholder="Digite para filtrar…">
          </div>
          <div style="display:flex; gap:8px;">
            <button id="limparBusca" type="button" class="btn secondary" title="Limpar">
              <i class="fa-solid fa-eraser"></i><span>Limpar</span>
            </button>
            <a href="{{ url_for('adicionar_tre') }}" class="btn" title="Enviar nova TRE">
              <i class="fa-solid fa-file-circle-plus"></i><span>Nova TRE</span>
            </a>
          </div>
        </div>

        {% if tres and tres|length > 0 %}
          <table id="tresTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Enviado em</th>
                <th>Status</th>
                <th>Dias</th>
                <th>Parecer</th>
                <th>Validado em</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tres|sort(attribute='data_envio', reverse=True) %}
              {% set st = (t.status or '').lower().strip() %}
              <tr
                data-id="{{ t.id }}"
                data-status="{{ st }}"
                data-enviado="{{ t.data_envio.strftime('%d/%m/%Y %H:%M') if t.data_envio else '' }}"
                data-busca="{{ (t.parecer_admin or '') ~ ' ' ~ (t.arquivo_pdf or '') }}"
              >
                <td class="text-muted">#{{ t.id }}</td>
                <td>
                  {% if t.data_envio %}
                    {{ t.data_envio.strftime('%d/%m/%Y %H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <span class="status-pill
                    {% if st == 'deferida' %}deferida
                    {% elif st == 'indeferida' %}indeferida
                    {% else %}pendente{% endif %}">
                    {% if st == 'deferida' %}Deferida
                    {% elif st == 'indeferida' %}Indeferida
                    {% else %}Pendente{% endif %}
                  </span>
                </td>
                <td>
                  {% if t.dias_validados is not none %}
                    {{ t.dias_validados }} <small style="color:#6b7280;">validados</small>
                    {% if t.dias_folga and t.dias_validados != t.dias_folga %}
                      <div style="font-size:.8rem; color:#6b7280;">({{ t.dias_folga }} solicitado)</div>
                    {% endif %}
                  {% else %}
                    {{ t.dias_folga or 0 }} <small style="color:#6b7280;">solicitado</small>
                  {% endif %}
                </td>
                <td class="text-truncate" style="max-width:420px;">
                  {{ t.parecer_admin or '—' }}
                </td>
                <td>
                  {% if t.validado_em %}
                    {{ t.validado_em.strftime('%d/%m/%Y %H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <a class="btn-action" href="{{ url_for('download_tre', tre_id=t.id) }}" title="Baixar PDF">
                    <i class="fa-solid fa-download"></i> Baixar
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Paginação (front-end) -->
          <div id="pagination" class="pagination"></div>
        {% else %}
          <div class="no-data">
            Você não possui TREs cadastradas.
          </div>
        {% endif %}
      </div>

      <div style="text-align:center; margin-top:4px;">
        <a href="{{ url_for('index') }}" class="btn-action">
          <i class="fas fa-arrow-left"></i> Voltar para a Página Inicial
        </a>
      </div>
    </div>
  </main>

  <!-- Rodapé -->
  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>
</body>
</html>
