<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Calendário de Folgas - Gestão de Ponto E.M José Padin Mouta</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=3, minimum-scale=1">

  <!-- ✅ Carrega TODOS os pesos usados no layout (evita “peso sintético” e variações) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- CSRF: token disponível para o JS -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #0051ff;
      --primary-soft: #dbe9ff;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --warning: #fb923c;
      --warning-soft: #fff4e5;
      --success: #22c55e;
      --success-soft: #e1fbe8;
      --danger: #ef4444;
      --danger-soft: #ffe4e6;

      --card-shadow: 0 14px 34px rgba(15,23,42,.1), 0 2px 4px rgba(15,23,42,.06);
      --radius: 18px;

      /* cores para eventos */
      --event: #1d4ed8;
      --event-soft: #e0edff;
      --event-border: rgba(29, 78, 216, .35);

      /* escala desktop p/ títulos */
      --ag-name-max: 14px;
      --ag-name-min: 11px;
      --ag-motivo-size: 12px;

      --ag-title-gap: 6px;
      --ag-badge-height: 18px;

      /* ✅ Mobile: largura uniforme das colunas (JS ajusta para a maior necessária) */
      --cal-col-w-mobile: 92px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at top, #e0f2ff 0, #f9fafb 45%, #eef2ff 100%);
      color: var(--text-main);

      /* ✅ evita variações por “bold sintético”/fallback */
      font-synthesis: none;
      -webkit-text-size-adjust: 100%;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1 0 auto; padding: 24px 12px 60px; box-sizing: border-box; }
    .shell { width: 100%; max-width: 980px; margin: 0 auto; }
    @media (min-width: 769px) { main { padding: 30px 24px 80px; } }

    /* ===== HEADER ===== */
    .header-desktop, .header-mobile { display: none; flex-shrink: 0; }

    /* Desktop */
    @media (min-width: 769px) {
      .header-desktop {
        display: flex; background-color: #007bff; padding: 15px 30px; width: 100%;
        align-items: center; justify-content: space-between; box-sizing: border-box;
        min-height: 110px; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,.15); color: #fff;
      }
      .left-section { display: flex; align-items: center; gap: 20px; }
      .logo { width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background: #fff; padding: 6px; }
      .text-container { display: flex; flex-direction: column; justify-content: center; text-align: left; color: #fff; }
      .escola-nome { font-weight: 700; font-size: 1.6rem; margin: 0; line-height: 1.1; }
      .escola-subtitulo { font-weight: 600; font-size: 1.1rem; margin-top: 4px; }
      .header-center-text-container {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
        font-weight: 800; font-size: 1.9rem; color: #fff; letter-spacing: 5px; user-select: none;
        white-space: nowrap; z-index: 1; text-shadow: 0 2px 5px rgba(0,0,0,.3);
      }
      .header-center-text { font-family: 'Montserrat', sans-serif; }
      .btn-home {
        background-color: #0fb300; color: #fff; padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 1.5rem;
        text-decoration: none; display: flex; align-items: center; gap: 8px;
        box-shadow: 0 2px 6px rgba(15,179,0,.8); transition: background-color .3s ease;
        position: absolute; right: 30px; top: 50%; transform: translateY(-50%); z-index: 2;
      }
      .btn-home:hover { background-color: #0d8a00; }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .header-mobile {
        display: block; width: 100%; box-sizing: border-box; color: #fff; position: sticky; top: 0; z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,.15); background-color: #007bff;
      }
      .header-top {
        display: flex; align-items: center; justify-content: center; gap: 15px; padding: 10px 15px;
        background-color: #007bff; text-align: center;
      }
      .logo { width: 48px; height: 48px; object-fit: contain; border-radius: 10px; background: #fff; padding: 6px; }
      .text-container { display: flex; flex-direction: column; justify-content: center; color: #fff; text-align: center; }
      .escola-nome { font-weight: 700; font-size: 1.3rem; margin: 0; line-height: 1.1; }
      .escola-subtitulo { font-weight: 600; font-size: 1rem; margin-top: 2px; }
      .header-bottom {
        background-color: #0056b3; text-align: center; padding: 12px 10px; font-weight: 800; font-size: 1rem;
        letter-spacing: 4px; user-select: none; color: #fff; box-shadow: inset 0 -2px 5px rgba(0,0,0,.2);
        display: flex; justify-content: center; align-items: center; gap: 12px; white-space: nowrap;
      }
      .btn-home-mobile {
        background-color: #0fb300; color: #fff; padding: 6px 10px; border-radius: 6px; font-weight: 600; font-size: 1rem;
        text-decoration: none; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(15,179,0,.8); transition: background-color .3s ease;
      }
      .btn-home-mobile:hover { background-color: #0d8a00; }
    }

    /* ===== HEADER CARD DA PÁGINA ===== */
    .page-header-card{
      background:#fff; border-radius:var(--radius); padding:16px 18px; margin:0 auto 16px;
      display:flex; align-items:center; gap:16px; box-shadow: var(--card-shadow); border-left:5px solid var(--primary);
    }
    .page-header-icon{
      display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#fff 0%,#e0edff 60%,#c7d9ff 100%);
      box-shadow:0 4px 12px rgba(37,99,235,.45); color:#2563eb; flex-shrink:0;
    }
    .page-header-icon i{ font-size:22px; }
    .page-header-content{ display:flex; flex-direction:column; gap:4px; }
    .page-header-title{ font-size:1.15rem; font-weight:800; margin:0; color:var(--text-main); }
    .page-header-subtitle{ font-size:0.9rem; margin:0; color:var(--text-muted); }
    @media (max-width:600px){
      .page-header-card{ padding:12px 14px; }
      .page-header-title{ font-size:1.05rem; }
      .page-header-subtitle{ font-size:0.82rem; }
    }

    /* ===== BARRA DE NAVEGAÇÃO ===== */
    .calendar-toolbar { width: 100%; max-width: 980px; margin: 0 auto 14px; }
    .navigation {
      display: grid; grid-template-columns: auto minmax(0,1fr) auto; align-items: center;
      column-gap: 10px; row-gap: 8px; padding: 10px 14px;
      background: linear-gradient(to right, #eff6ff, #f9fafb);
      border-radius: 16px; border: 1px solid var(--border-soft); box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    .navigation .button-container { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; min-width:0; }
    .navigation .button-container:nth-child(1){ justify-content:flex-start; }
    .navigation .button-container:nth-child(2){
      justify-content:center; background:#fff; padding:6px 10px; border-radius:999px; box-shadow:0 4px 14px rgba(15,23,42,.12);
      min-width:0;
    }
    .navigation .button-container:nth-child(3){ justify-content:flex-end; }
    .navigation a, .navigation button{
      padding:6px 14px; background:var(--primary); color:#f9fafb; text-decoration:none; border-radius:999px;
      font-size:13px; font-weight:600; display:inline-flex; align-items:center; justify-content:center; border:none; cursor:pointer;
      box-shadow:0 3px 8px rgba(15,23,42,.25); gap:6px; transition: background-color .15s ease-out, box-shadow .15s, transform .15s; white-space:nowrap;
    }
    .navigation a:hover, .navigation button:hover{ background:var(--primary-dark); box-shadow:0 5px 12px rgba(15,23,42,.35); transform: translateY(-1px); }
    .navigation select{
      padding:7px 34px 7px 14px; border-radius:999px; border:2px solid var(--primary-soft);
      font-size:13px; font-weight:600; background:linear-gradient(to bottom,#fff,#f3f4ff); color:var(--text-main);
      box-shadow:0 2px 6px rgba(15,23,42,.1); outline:none; appearance:none; min-width:110px; text-align-last:center; cursor:pointer;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath d='M6 9l6 6 6-6' fill='none' stroke='%230077ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 10px center; background-size:14px;
    }
    .navigation select:focus { border-color:var(--primary); box-shadow:0 0 0 2px rgba(37,99,235,.18); }
    #btnHoje{ background:#eff6ff; color:var(--primary-dark); border:2px solid var(--primary-soft); box-shadow:0 2px 8px rgba(148,163,184,.6); padding-inline:16px; }
    #btnHoje:hover{ background:var(--primary-soft); color:var(--primary-dark); }

    /* ===== CARD DO CALENDÁRIO ===== */
    .calendar-container{
      width:100%; margin:0 auto 10px; background:#fff; border-radius:16px; box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:18px 18px 22px; border:1px solid rgba(148,163,184,.35); backdrop-filter: blur(10px);
      transition: transform .18s ease-out, box-shadow .18s ease-out, border-color .18s ease-out;
      overflow-x: hidden; /* desktop: não mostrar barra horizontal */
    }
    .calendar-container:hover{ transform: translateY(-2px); box-shadow:0 22px 55px rgba(15,23,42,.16); border-color:var(--primary-soft); }
    @media (max-width: 768px){
      .calendar-container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    }

    /* ===== CALENDÁRIO ===== */
    .calendar{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      gap:6px;
      width:100%;
      min-width:0;
    }
    @media (max-width: 768px){
      /* ✅ Mobile: colunas UNIFORMES (todas acompanham a maior) */
      .calendar{
        margin-top:10px;
        gap:5px;

        width: max-content;      /* permite scroll horizontal */
        min-width: 640px;        /* base mínima */

        grid-template-columns: repeat(7, var(--cal-col-w-mobile));
      }
    }
    .calendar > * { min-width:0; }
    .calendar .day { min-width:0; }

    .calendar .day.weekdays{
      font-weight:600; background:linear-gradient(to bottom,#0ea5e9,#0369a1); color:#f9fafb; text-align:center; padding:6px 0;
      border-radius:10px; font-size:11px; height:34px; min-height:34px; display:flex; justify-content:center; align-items:center;
      text-transform:uppercase; letter-spacing:.06em; box-shadow:0 5px 12px rgba(3,105,161,.4);
    }

    .calendar .day:not(.weekdays){
      background:#f9fafb; padding:8px 7px 6px; text-align:right; border-radius:14px; border:1px solid var(--border-soft);
      min-height:90px; font-size:13px; position:relative;
      display:flex; flex-direction:column; gap:6px;
      transition: border-color .16s, box-shadow .16s, transform .16s, background-color .16s;
      overflow: hidden; /* não vaza */
    }
    .calendar .day:not(.weekdays):hover{
      border-color:var(--primary-soft); background:#fff; box-shadow:0 10px 25px rgba(15,23,42,.12); transform: translateY(-2px);
    }

    .calendar .day.today{
      border:2px solid var(--primary); background:linear-gradient(135deg,#eef2ff,#e0f2fe);
      box-shadow:0 0 0 1px rgba(37,99,235,.45), 0 14px 30px rgba(37,99,235,.35); font-weight:700;
    }
    .calendar .day.today::after{
      content:"HOJE"; position:absolute; left:8px; top:6px; font-size:9px; font-weight:700; text-transform:uppercase;
      letter-spacing:.08em; color:var(--primary-dark); background:rgba(255,255,255,.96); padding:2px 6px; border-radius:999px;
      border:1px solid rgba(191,219,254,.85);
    }

    /* ===== CARD AGENDAMENTO ===== */
    .agendamento{
      width:100%;
      max-width:100%;
      min-width:0;
      padding:6px 8px;
      margin-top:3px;
      border-radius:10px;
      font-size:13px;
      border:1px solid transparent;
      display:flex;
      flex-direction:column;
      line-height:1.25;
      gap:3px;
      user-select:none;
      overflow:hidden;

      /* ✅ DESKTOP/MOBILE: estrutura centralizada como no mobile */
      text-align:center;
      align-items:stretch;
    }
    .agendamento + .agendamento { margin-top:6px; }

    .calendar .agenda-em-espera { background:#fed7aa; color:#7c2d12; border-color:var(--warning); font-weight:700; }
    .calendar .agenda-em-espera:hover { background:#ffedd5; }
    .calendar .agenda-deferido { background:#a7f3d0; color:#065f46; border-color:var(--success); font-weight:700; }
    .calendar .agenda-deferido:hover { background:#d1fae5; }
    .calendar .agenda-indeferido { background:#fecaca; color:#7f1d1d; border-color:var(--danger); font-weight:700; }
    .calendar .agenda-indeferido:hover { background:#fee2e2; }

    .agendamento.clickable { cursor: pointer; }
    .agendamento.clickable:focus { outline: 2px solid rgba(37,99,235,.65); outline-offset: 2px; }
    .agendamento.clickable:hover { box-shadow: 0 10px 20px rgba(15,23,42,.12); transform: translateY(-1px); }

    /* =========================================================
       ✅ TÍTULO (DESKTOP) — IGUAL AO MOBILE
       ========================================================= */
    .ag-title{
      display:inline-flex;
      flex-direction:column;
      align-items:stretch;
      gap:4px;
      width:fit-content;
      max-width:100%;
      margin:0 auto;
      font-family:'Montserrat',sans-serif;
      font-synthesis:none;
      letter-spacing:0;
      line-height:1.15;
    }

    .ag-name{
      display:inline-block;
      width:auto;
      max-width:100%;
      font-weight:800;
      font-size: var(--ag-name-max);
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:clip;
      text-align:center;
      letter-spacing:0;
    }

    .ag-motivo{
      width:100%;
      max-width:100%;
      font-weight:800;
      font-size: var(--ag-motivo-size);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: var(--ag-badge-height);
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.35);
      box-shadow: 0 1px 0 rgba(15,23,42,.06);
      letter-spacing:.02em;
      line-height:1;
    }

    .ag-title.is-wrap{
      width:100%;
      max-width:100%;
    }
    .ag-title.is-wrap .ag-name{
      display:block;
      width:100%;
      white-space:normal;
      overflow:visible;
      overflow-wrap: break-word;
      text-align:center;
    }
    .ag-title.is-wrap .ag-motivo{
      width:100%;
    }

    /* ===== SUBSTITUTOS ===== */
    .ag-sub-lines{
      width:100%;
      min-width:0;
      display:grid;
      gap:2px;
      justify-items:center;
      margin-top:2px;
    }

    .ag-sub-line{
      width:100%;
      min-width:0;
      display:flex;
      align-items:baseline;
      gap:4px;
      font-size:11px;
      font-weight:700;
      color: rgba(15, 23, 42, .88);
      line-height:1.15;
      justify-content:center;
      text-align:center;
      white-space:normal;
      word-break: normal;
      overflow-wrap: normal;
      hyphens: none;
      letter-spacing:0;
      flex-wrap:wrap;
    }
    .ag-sub-line .sub-k{
      flex:0 0 auto;
      font-weight:800;
      white-space:nowrap;
    }
    .ag-sub-line .sub-v{
      flex:0 0 auto;
      min-width:0;
      white-space:normal;
      word-break: normal;
      overflow-wrap: normal;
      hyphens: none;
      text-align:center;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 768px) {
      .calendar-container { padding: 12px 10px 16px; }

      .navigation { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; }
      .navigation .button-container:nth-child(1){ grid-column:1; grid-row:1; justify-content:center; }
      .navigation .button-container:nth-child(3){ grid-column:2; grid-row:1; justify-content:center; }
      .navigation .button-container:nth-child(2){ grid-column:1 / span 2; grid-row:2; justify-content:center; padding:6px 8px; }

      .navigation a, .navigation button { width:100%; justify-content:center; padding:6px 10px; font-size:11px; }
      .navigation .button-container:nth-child(2) button { width:auto; }
      .navigation select { min-width:96px; font-size:11px; padding:6px 30px 6px 12px; }

      .calendar .day.weekdays{ font-size:10px; height:34px; min-height:34px; }
      .calendar .day:not(.weekdays){
        font-size:11px;
        min-height:86px;
        overflow:hidden;
      }

      .agendamento{
        font-size:12px;
        padding:6px 8px;
        width:100%;
        max-width:100%;
        align-self:stretch;
        text-align:center;
        align-items:stretch;
      }

      .ag-title{
        display:flex;
        flex-direction:column;
        align-items:stretch;
        gap:4px;
        flex-wrap:nowrap;
        width:100%;
        max-width:100%;
        margin:0;
      }

      .ag-name{
        width:100%;
        text-align:center;
        font-size:13px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:clip;
        display:block;
      }

      .ag-motivo{
        width:100%;
        justify-content:center;
        align-self:stretch;
        font-size:12px;
        height:20px;
        padding:0 10px;
        white-space:nowrap;
      }

      .ag-sub-lines{ width:100%; justify-items:center; }
      .ag-sub-line{
        width:100%;
        justify-content:center;
        flex-wrap:nowrap !important;
        white-space:nowrap !important;
        font-size:12px;
      }
      .ag-sub-line .sub-k,
      .ag-sub-line .sub-v{
        white-space:nowrap !important;
      }
      .ag-sub-line .sub-v{
        flex:0 0 auto;
        min-width:0;
        text-align:center;
      }

      .ag-sub-line.is-split{
        flex-wrap:wrap !important;
        white-space:normal !important;
      }
      .ag-sub-line.is-split .sub-k,
      .ag-sub-line.is-split .sub-v{
        flex:0 0 100%;
        white-space:normal !important;
        word-break: normal !important;
        overflow-wrap: normal !important;
        text-align:center;
      }

      .legenda{ min-width:640px; }
    }

    /* ===== EVENTO ===== */
    .evento{
      padding:6px 8px; margin-top:3px; border-radius:10px; font-size:12px; text-align:left;
      border:1px solid var(--event-border);
      display:flex; flex-direction:column; align-items:flex-start; line-height:1.25; gap:2px;
      background: var(--event-soft); color: var(--event);
      font-weight:800;
      width: 100%;
      max-width: 100%;
      min-width: 0;
      overflow:hidden;
    }
    .evento .evento-titulo{
      width: 100%;
      min-width: 0;
      display: block;
      text-align: left;
      white-space: normal !important;
      word-break: normal !important;
      overflow-wrap: normal !important;
      hyphens: none !important;
      line-height: 1.2;
      font-size: 12px;
    }
    @media (max-width: 768px){
      .evento .evento-titulo{ font-size: 12px; }
    }
    .evento .evento-horario{
      width: 100%;
      text-align: center;
      font-size:10px;
      font-weight:700;
      color: rgba(29, 78, 216, .88);
      opacity:.95;
      line-height: 1.2;
      white-space:nowrap;
    }

    /* ===== LEGENDA ===== */
    .legenda{
      margin-top:20px; padding:14px 16px 10px; background:linear-gradient(135deg,#f9fafb,#eef2ff);
      border:1px solid var(--border-soft); border-radius:14px; box-shadow:0 10px 30px rgba(15,23,42,.08);
      font-size:13px;
      width:100%;
      min-width:0;
    }
    @media (max-width: 768px){
      .legenda{ min-width:640px; }
    }
    .legenda h3{ text-align:left; margin:0 0 10px; color:var(--text-muted); font-size:13px; text-transform:uppercase; letter-spacing:.08em; }
    .legenda div{ display:flex; align-items:center; margin-bottom:6px; gap:10px; font-size:13px; color:var(--text-main); }
    .legenda .cor{ width:22px; height:22px; border-radius:999px; border:1px solid #cbd5f5; box-shadow:0 2px 6px rgba(15,23,42,.16); }

    /* ===== MODAL (ADMIN) ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 3000;
      background: rgba(0,0,0,.55);
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    .modal.open { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .modal-header {
      padding: 14px 16px;
      background: linear-gradient(90deg,#f9fafb 0,#eef2ff 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 900;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: #64748b;
      font-size: 1.1rem;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .15s ease, color .15s ease;
    }
    .modal-close:hover { background: rgba(100,116,139,.12); color: #0f172a; }
    .modal-body { padding: 14px 16px 16px; background: #fff; }
    .modal-help {
      margin: 0 0 10px;
      color: #6b7280;
      font-size: .86rem;
      line-height: 1.25rem;
    }

    .sub-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .sub-grid{ grid-template-columns: 1fr; }
    }

    .modal-field { display: grid; gap: 6px; }
    .modal-label {
      font-size: .78rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .08em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      font-size:.8rem;
      font-weight:900;
      background:#eef2ff;
      color:#1d4ed8;
      border:1px solid rgba(29,78,216,.25);
      flex:0 0 auto;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: .95rem;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .modal-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,.45);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn-secondary {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #111827;
      font-weight: 900;
      cursor: pointer;
    }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-primary {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      background: #2563eb;
      color: #fff;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(37,99,235,.25);
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-danger-soft {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 900;
      cursor: pointer;
    }
    .btn-danger-soft:hover { background: #fecaca; }

    /* Footer */
    footer {
      background: linear-gradient(to right, #222, #444);
      color: #ddd; text-align: center; padding: 15px 0; font-size: 14px;
      border-top: 2px solid #555; box-shadow: 0 -2px 10px rgba(0,0,0,.3); width: 100%; flex-shrink: 0;
    }
    footer p { margin: 5px 0; font-size: 15px; font-weight: 300; }
    footer a { color: #fff; text-decoration: none; font-weight: 500; transition: color .3s ease-in-out; }
    footer a:hover { color: #00aaff; }
  </style>
</head>

<body>
  {% set can_edit_sub = (current_user.is_authenticated and (current_user.tipo|default('') == 'administrador')) %}

  <!-- Cabeçalho Desktop -->
  <header class="header-desktop">
    <div class="left-section">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>

    <div class="header-center-text-container">
      <div class="header-center-text">PORTAL DO SERVIDOR</div>
    </div>

    <a href="{{ url_for('index') }}" class="btn-home" title="Página Inicial">
      <i class="fas fa-home"></i>
    </a>
  </header>

  <!-- Cabeçalho Mobile -->
  <header class="header-mobile">
    <div class="header-top">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Escola" class="logo" />
      <div class="text-container">
        <div class="escola-nome">Escola Municipal</div>
        <div class="escola-subtitulo">José Padin Mouta</div>
      </div>
    </div>
    <div class="header-bottom">
      <span>PORTAL DO SERVIDOR</span>
      <a href="{{ url_for('index') }}" class="btn-home-mobile" title="Página Inicial">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </header>

  <main>
    <div class="shell">

      <!-- Header card da página -->
      <div class="page-header-card">
        <div class="page-header-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="page-header-content">
          <p class="page-header-title">Calendário de Folgas</p>
          <p class="page-header-subtitle">Visualize folgas em espera, deferidas e indeferidas.</p>
        </div>
      </div>

      <!-- NAVIGATION -->
      <div class="calendar-toolbar">
        <div class="navigation">
          <div class="button-container">
            <a href="{{ url_for('calendario', year=prev_year, month=prev_month) }}" style="white-space: nowrap;">
              <i class="fas fa-arrow-left"></i> Mês Anterior
            </a>
          </div>

          <div class="button-container">
            <select id="selectMes" aria-label="Selecionar mês">
              {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                  {{ datetime.date(2000, m, 1).strftime('%B') }}
                </option>
              {% endfor %}
            </select>
            <select id="selectAno" aria-label="Selecionar ano">
              {% for y in range(inicio_ano, fim_ano + 1) %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
            <button type="button" id="btnHoje" title="Ir para o mês atual">
              <i class="fas fa-calendar-day"></i> Hoje
            </button>
          </div>

          <div class="button-container">
            <a href="{{ url_for('calendario', year=next_year, month=next_month) }}" style="white-space: nowrap;">
              Próximo Mês <i class="fas fa-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- CALENDÁRIO -->
      <div class="calendar-container">
        <div class="calendar">
          <div class="day weekdays">Seg</div>
          <div class="day weekdays">Ter</div>
          <div class="day weekdays">Qua</div>
          <div class="day weekdays">Qui</div>
          <div class="day weekdays">Sex</div>
          <div class="day weekdays">Sáb</div>
          <div class="day weekdays">Dom</div>

          {% set start_day = datetime.date(year, month, 1).weekday() %}
          {% set next_month_tmp = (month + 1) if month < 12 else 1 %}
          {% set next_year_tmp = year if month < 12 else year + 1 %}
          {% set days_in_month = (datetime.date(next_year_tmp, next_month_tmp, 1) - datetime.timedelta(days=1)).day %}
          {% set hoje = datetime.date.today() %}

          {% for _ in range(start_day) %}
            <div></div>
          {% endfor %}

          {% for day in range(1, days_in_month + 1) %}
            {% set current_day = datetime.date(year, month, day) %}
            {% set eventos = (eventos_por_data.get(current_day, []) if eventos_por_data is defined else []) %}
            {% set folgas = folgas_por_data.get(current_day, []) %}

            <div class="day {% if current_day == hoje %}today{% endif %}">
              {{ day }}

              {# EVENTOS DA ESCOLA #}
              {% if eventos %}
                {% for ev in eventos %}
                  <div class="evento" {% if ev.cor %}style="border-color: {{ ev.cor }}55; background: {{ ev.cor }}14; color: {{ ev.cor }};"{% endif %}>
                    <div class="evento-titulo">{{ (ev.nome or 'Evento') }}</div>

                    {% if ev.hora_inicio or ev.hora_fim %}
                      <div class="evento-horario">
                        {% if ev.hora_inicio and ev.hora_fim %}
                          {{ ev.hora_inicio.strftime('%H:%M') }}–{{ ev.hora_fim.strftime('%H:%M') }}
                        {% elif ev.hora_inicio %}
                          {{ ev.hora_inicio.strftime('%H:%M') }}
                        {% else %}
                          até {{ ev.hora_fim.strftime('%H:%M') }}
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% endif %}

              {# AGENDAMENTOS/FOLGAS #}
              {% if folgas %}
                {% for folga in folgas %}
                  {% set motivo_txt = (folga.motivo or folga.tipo or folga.tipo_folga or '')|upper %}
                  {% set texto_obs = (
                        folga.observacao
                        or folga.observacoes
                        or folga.justificativa
                        or folga.descricao
                        or folga.parecer_admin
                        or ''
                      )|lower %}
                  {% set rotina_txt = (folga.rotina or '')|lower %}
                  {% set is_bh = motivo_txt == 'BH' %}
                  {% set is_ajuste = 'ajuste' in texto_obs or 'recupera' in texto_obs or 'retroativ' in texto_obs or 'consumo' in texto_obs or rotina_txt == 'ajuste' %}
                  {% if not (is_bh and is_ajuste) %}

                    {# ===== NOME NORMALIZADO (somente exibição) ===== #}
                    {% set nome_full_disp = (folga.funcionario.nome or '')|pt_title %}
                    {% set abreviado = (folga.funcionario.nome or '')|abbr_name %}
                    {% set info_modal = nome_full_disp ~ ' — ' ~ motivo_txt ~ ' (' ~ current_day.strftime('%d/%m/%Y') ~ ')' %}

                    <div
                      class="agendamento
                        {% if folga.status == 'em_espera' %}agenda-em-espera
                        {% elif folga.status == 'deferido' %}agenda-deferido
                        {% elif folga.status == 'indeferido' %}agenda-indeferido
                        {% endif %}
                        {% if can_edit_sub %} clickable{% endif %}
                      "
                      data-ag-id="{{ folga.id }}"
                      data-sub-nome="{{ (folga.nome_substituto or '')|e }}"
                      data-info="{{ info_modal|e }}"
                      {% if can_edit_sub %}
                        role="button"
                        tabindex="0"
                        title="Clique para editar substituição"
                        onclick="openSubModalFromEl(this)"
                        onkeydown="handleAgKey(event, this)"
                      {% endif %}
                    >
                      <div class="ag-title" data-ag-title="1">
                        <span class="ag-name" data-ag-name="1">{{ abreviado }}</span>
                        <span class="ag-motivo" data-ag-motivo="1">{{ motivo_txt }}</span>
                      </div>

                      <div class="ag-sub-lines" data-sub-lines="1"></div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="legenda">
          <h3>Legenda</h3>
          <div><span class="cor" style="background-color:#e0edff; border: 1px solid rgba(29,78,216,.35);"></span><strong>Evento da escola</strong></div>
          <div><span class="cor" style="background-color:#fed7aa;"></span><strong>Folga em espera</strong></div>
          <div><span class="cor" style="background-color:#a7f3d0;"></span><strong>Folga deferida</strong></div>
          <div><span class="cor" style="background-color:#fecaca;"></span><strong>Folga indeferida</strong></div>
          <div><span class="cor" style="background-color:#e9f2ff; border: 2px solid #007bff;"></span><strong>Dia atual</strong></div>
        </div>
      </div>
    </div>
  </main>

  {% if can_edit_sub %}
  <div id="subModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="subModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="subModalTitle">
          <i class="fas fa-user-edit"></i>
          Substitutos por Turno (Agendamento)
        </h3>
        <button type="button" class="modal-close" aria-label="Fechar" onclick="closeSubModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-help" id="subModalHelp">
          Preencha os turnos (M/I/T/N). Se deixar tudo em branco, remove substitutos.
        </p>

        <div class="sub-grid">
          <div class="modal-field">
            <div class="modal-label"><span class="pill">M</span> Manhã</div>
            <input id="subM" class="modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="modal-field">
            <div class="modal-label"><span class="pill">I</span> Intermediário</div>
            <input id="subI" class="modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="modal-field">
            <div class="modal-label"><span class="pill">T</span> Tarde</div>
            <input id="subT" class="modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>

          <div class="modal-field">
            <div class="modal-label"><span class="pill">N</span> Noite</div>
            <input id="subN" class="modal-input" type="text" maxlength="255" placeholder="Nome da substituta/substituto">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-danger-soft" onclick="clearSubTurnos()">
            <i class="fas fa-eraser"></i>
            Limpar
          </button>
          <button type="button" class="btn-secondary" onclick="closeSubModal()">
            Cancelar
          </button>
          <button type="button" class="btn-primary" id="btnSaveSub" onclick="saveSubNome()">
            <i class="fas fa-save"></i>
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <footer>
    <p>&copy; 2025 - Desenvolvido por Nilson Cruz | Todos os direitos reservados</p>
  </footer>

  <script>
    // ====== NAV (mês/ano) ======
    const selMes = document.getElementById('selectMes');
    const selAno = document.getElementById('selectAno');
    const btnHoje = document.getElementById('btnHoje');

    function irPara(ano, mes) {
      ano = parseInt(ano, 10);
      mes = parseInt(mes, 10);
      if (!ano || !mes) return;
      window.location.href = `/calendario/${ano}/${mes}`;
    }

    if (selMes) selMes.addEventListener('change', () => irPara(selAno.value, selMes.value));
    if (selAno) selAno.addEventListener('change', () => irPara(selAno.value, selMes.value));

    if (btnHoje) {
      btnHoje.addEventListener('click', () => {
        const hoje = new Date();
        irPara(hoje.getFullYear(), hoje.getMonth() + 1);
      });
    }

    // ====== SUBSTITUTOS: parse/serialize/render ======
    const SHIFT_KEYS = ['M','I','T','N'];

    function getCSRFToken() {
      const el = document.querySelector('meta[name="csrf-token"]');
      return el ? el.getAttribute('content') : '';
    }

    function cleanSpaces(s) {
      return String(s ?? '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function normalizeKey(raw) {
      const t = cleanSpaces(raw).toUpperCase();
      if (t === 'M' || t.startsWith('MANH')) return 'M';
      if (t === 'I' || t.startsWith('INTER')) return 'I';
      if (t === 'T' || t.startsWith('TAR')) return 'T';
      if (t === 'N' || t.startsWith('NOI')) return 'N';
      const c = t.charAt(0);
      if (SHIFT_KEYS.includes(c)) return c;
      return null;
    }

    function parseSubstitutoString(input) {
      const out = { M:'', I:'', T:'', N:'' };

      let s = String(input ?? '');
      if (!s.trim()) return out;

      s = s.replace(/^\s*\(?\s*substituto\s*:\s*/i, '');
      s = s.replace(/\)?\s*$/,'');
      s = s.replace(/\r\n/g, '\n');

      const unified = s
        .replace(/[|]/g, ';')
        .replace(/\n+/g, ';')
        .replace(/,+/g, ';')
        .replace(/;+/, ';');

      const re = /(^|[;])\s*(M|I|T|N|MANH[ÃA]?|INTERMEDI[ÁA]RIO|INTERMEDIARIO|TARDE|NOITE)\s*[:=\-]\s*([^;]+)\s*/ig;
      let found = false;
      let match;
      while ((match = re.exec(unified)) !== null) {
        found = true;
        const k = normalizeKey(match[2]);
        const v = cleanSpaces(match[3]);
        if (!k || !v) continue;
        if (!out[k]) out[k] = v;
        else if (out[k].toLowerCase() !== v.toLowerCase()) out[k] = cleanSpaces(out[k] + ' / ' + v);
      }
      if (found) return out;

      const parts = unified
        .split(';')
        .map(p => cleanSpaces(p))
        .filter(Boolean);

      if (parts.length === 0) return out;
      if (parts.length === 1) { out.M = parts[0]; return out; }

      for (let i=0; i<parts.length && i<4; i++) out[SHIFT_KEYS[i]] = parts[i];

      if (parts.length > 4) {
        const rest = parts.slice(4).join(' / ');
        out.N = cleanSpaces([out.N, rest].filter(Boolean).join(' / '));
      }

      return out;
    }

    function serializeSubstituto(obj) {
      const pieces = [];
      for (const k of SHIFT_KEYS) {
        const v = cleanSpaces(obj?.[k] ?? '');
        if (!v) continue;

        const normalizedPieces = [];
        for (const part of v.split('/')) {
          const c = cleanSpaces(part);
          if (!c) continue;
          const key = c.toLowerCase();
          if (normalizedPieces.some(x => x.toLowerCase() === key)) continue;
          normalizedPieces.push(c);
        }
        pieces.push(`${k}: ${normalizedPieces.join(' / ')}`);
      }
      return pieces.join('; ');
    }

    function renderSubLinesForEl(agEl) {
      const box = agEl.querySelector('[data-sub-lines="1"]');
      if (!box) return;

      const raw = (agEl.getAttribute('data-sub-nome') || '').trim();
      const parsed = parseSubstitutoString(raw);

      box.innerHTML = '';
      for (const k of SHIFT_KEYS) {
        const v = cleanSpaces(parsed[k]);
        if (!v) continue;

        const div = document.createElement('div');
        div.className = 'ag-sub-line';

        const sK = document.createElement('span');
        sK.className = 'sub-k';
        sK.textContent = `${k}:`;

        const sV = document.createElement('span');
        sV.className = 'sub-v';
        sV.textContent = v;

        div.appendChild(sK);
        div.appendChild(sV);
        box.appendChild(div);
      }
    }

    // ==========================================================
    // ✅ FIX: MOBILE colunas uniformes SEM “crescimento infinito”
    // - iOS/Android disparam "resize" ao scroll (barra de endereço)
    // - scrollWidth em elementos 100% vira feedback positivo
    // Solução: medir texto real via canvas.measureText (intrínseco)
    // ==========================================================
    let __lastMobileColW = 0;

    const __measureCanvas = document.createElement('canvas');
    const __measureCtx = __measureCanvas.getContext('2d');

    function _px(v){
      const n = parseFloat(String(v || '0').replace('px',''));
      return Number.isFinite(n) ? n : 0;
    }

    function _fontForEl(el){
      const cs = getComputedStyle(el);
      // Canvas entende bem esse formato
      const style = cs.fontStyle || 'normal';
      const variant = cs.fontVariant || 'normal';
      const weight = cs.fontWeight || '400';
      const size = cs.fontSize || '12px';
      const family = cs.fontFamily || 'sans-serif';
      return `${style} ${variant} ${weight} ${size} ${family}`;
    }

    function _measureTextEl(el){
      const text = (el.textContent || '').trim();
      if (!text) return 0;

      __measureCtx.font = _fontForEl(el);
      let w = __measureCtx.measureText(text).width || 0;

      // aproxima letter-spacing (se existir)
      const cs = getComputedStyle(el);
      const ls = cs.letterSpacing;
      if (ls && ls !== 'normal') {
        const lsPx = _px(ls);
        if (lsPx && text.length > 1) w += (text.length - 1) * lsPx;
      }

      return Math.ceil(w);
    }

    function syncMobileColumnWidth() {
      if (!window.matchMedia('(max-width: 768px)').matches) return;

      const cal = document.querySelector('.calendar');
      if (!cal) return;

      // Base mínima
      let maxText = 92;

      // Medir texto REAL, não largura da caixa (evita loop)
      cal.querySelectorAll('.ag-name, .ag-motivo, .ag-sub-line, .evento .evento-titulo').forEach((el) => {
        maxText = Math.max(maxText, _measureTextEl(el));
      });

      const sampleDay = cal.querySelector('.day:not(.weekdays)');
      const sampleAg  = cal.querySelector('.agendamento');
      const sampleEv  = cal.querySelector('.evento');

      const dayPad = sampleDay ? (_px(getComputedStyle(sampleDay).paddingLeft) + _px(getComputedStyle(sampleDay).paddingRight)) : 14;
      const agPad  = sampleAg  ? (_px(getComputedStyle(sampleAg).paddingLeft)  + _px(getComputedStyle(sampleAg).paddingRight))  : 16;
      const evPad  = sampleEv  ? (_px(getComputedStyle(sampleEv).paddingLeft)  + _px(getComputedStyle(sampleEv).paddingRight))  : 16;

      const innerPad = Math.max(agPad, evPad);
      const extra = 12;

      // Resultado final (com cap para não explodir por algum texto fora da curva)
      let colW = Math.ceil(maxText + dayPad + innerPad + extra);

      // Cap "seguro" (ajuste se quiser mais largo)
      colW = Math.max(92, Math.min(colW, 220));

      // Evita qualquer micro-variação ficar “dançando”
      if (!__lastMobileColW) __lastMobileColW = colW;
      if (Math.abs(colW - __lastMobileColW) <= 1) colW = __lastMobileColW;
      else __lastMobileColW = colW;

      cal.style.setProperty('--cal-col-w-mobile', `${colW}px`);

      const legenda = document.querySelector('.legenda');
      if (legenda) {
        const gap = _px(getComputedStyle(cal).gap) || 5;
        const totalW = (colW * 7) + (gap * 6);
        legenda.style.minWidth = `${Math.max(640, totalW)}px`;
      }
    }

    // ====== MOBILE: substitutos 1 linha primeiro (reduz fonte; fallback split) ======
    function fitSubLinesMobile() {
      if (!window.matchMedia('(max-width: 768px)').matches) return;

      const MAX_PX = 12;
      const MIN_PX = 11;

      document.querySelectorAll('.ag-sub-line').forEach((line) => {
        line.classList.remove('is-split');
        line.style.fontSize = `${MAX_PX}px`;

        let fits = (line.scrollWidth <= line.clientWidth + 1);

        if (!fits) {
          for (let px = MAX_PX - 1; px >= MIN_PX; px--) {
            line.style.fontSize = `${px}px`;
            fits = (line.scrollWidth <= line.clientWidth + 1);
            if (fits) break;
          }
        }

        if (!fits) {
          line.classList.add('is-split');
          line.style.fontSize = '12px';
        }
      });
    }

    function getLineHeightPx(el) {
      const cs = window.getComputedStyle(el);
      const lh = parseFloat(cs.lineHeight);
      if (!Number.isFinite(lh) || lh <= 0) {
        const fs = parseFloat(cs.fontSize) || 12;
        return fs * 1.2;
      }
      return lh;
    }

    function countLines(el) {
      const lh = getLineHeightPx(el);
      const h = el.scrollHeight;
      return Math.max(1, Math.round(h / lh));
    }

    function fitEventoTitlesMobile() {
      if (!window.matchMedia('(max-width: 768px)').matches) return;

      const MAX_PX = 13;
      const MIN_PX = 11;

      document.querySelectorAll('.evento .evento-titulo').forEach((t) => {
        t.style.fontSize = `${MAX_PX}px`;

        const okNow = () => (countLines(t) <= 2) && (t.scrollWidth <= t.clientWidth + 1);

        if (okNow()) return;

        for (let px = MAX_PX - 1; px >= MIN_PX; px--) {
          t.style.fontSize = `${px}px`;
          if (okNow()) break;
        }
      });
    }

    // ====== DESKTOP: shrink controlado + fallback ======
    function fitAgendamentoTitlesDesktop() {
      if (window.matchMedia('(max-width: 768px)').matches) return;

      const titles = document.querySelectorAll('.agendamento [data-ag-title="1"]');
      if (!titles.length) return;

      const rootStyles = getComputedStyle(document.documentElement);
      const MAX_PX = parseInt(rootStyles.getPropertyValue('--ag-name-max')) || 14;
      const MIN_PX = parseInt(rootStyles.getPropertyValue('--ag-name-min')) || 11;
      const EPS = 2;

      const setFont = (el, px) => el.style.setProperty('font-size', `${px}px`);
      const isOverflowing = (el) => (el.scrollWidth > (el.clientWidth + EPS));

      for (const title of titles) {
        const nameEl = title.querySelector('[data-ag-name="1"]');
        const badgeEl = title.querySelector('[data-ag-motivo="1"]');
        if (!nameEl || !badgeEl) continue;

        title.classList.remove('is-wrap');
        nameEl.style.whiteSpace = 'nowrap';
        nameEl.style.overflow = 'hidden';
        setFont(nameEl, MAX_PX);

        if (!isOverflowing(nameEl)) continue;

        let fitted = false;
        for (let px = MAX_PX - 1; px >= MIN_PX; px--) {
          setFont(nameEl, px);
          if (!isOverflowing(nameEl)) { fitted = true; break; }
        }
        if (fitted) continue;

        title.classList.add('is-wrap');
        setFont(nameEl, MAX_PX);
        nameEl.style.whiteSpace = 'normal';
        nameEl.style.overflow = 'visible';
      }
    }

    function scheduleRefitAll() {
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          syncMobileColumnWidth();
          fitAgendamentoTitlesDesktop();
          fitSubLinesMobile();
          fitEventoTitlesMobile();
        });
      });

      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
          syncMobileColumnWidth();
          fitAgendamentoTitlesDesktop();
          fitSubLinesMobile();
          fitEventoTitlesMobile();
        });
      }
    }

    // ====== ADMIN: Modal M/I/T/N ======
    const CAN_EDIT_SUB = {{ 'true' if can_edit_sub else 'false' }};

    {% if can_edit_sub %}
    let subCurrentAgId = null;
    let subCurrentEl = null;

    function openSubModalFromEl(el) {
      if (!CAN_EDIT_SUB) return;

      const agId = el?.getAttribute('data-ag-id');
      if (!agId) return;

      subCurrentAgId = agId;
      subCurrentEl = el;

      const raw = (el.getAttribute('data-sub-nome') || '').trim();
      const info = (el.getAttribute('data-info') || '').trim();
      const parsed = parseSubstitutoString(raw);

      const modal = document.getElementById('subModal');
      const help  = document.getElementById('subModalHelp');

      if (help && info) {
        help.textContent = `Agendamento: ${info}. Preencha M/I/T/N (em branco remove).`;
      }

      document.getElementById('subM').value = parsed.M || '';
      document.getElementById('subI').value = parsed.I || '';
      document.getElementById('subT').value = parsed.T || '';
      document.getElementById('subN').value = parsed.N || '';

      modal.classList.add('open');
      setTimeout(() => document.getElementById('subM').focus(), 50);
    }

    function handleAgKey(e, el) {
      if (!CAN_EDIT_SUB) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openSubModalFromEl(el);
      }
    }

    function closeSubModal() {
      const modal = document.getElementById('subModal');
      if (modal) modal.classList.remove('open');
      subCurrentAgId = null;
      subCurrentEl = null;
    }

    function clearSubTurnos() {
      document.getElementById('subM').value = '';
      document.getElementById('subI').value = '';
      document.getElementById('subT').value = '';
      document.getElementById('subN').value = '';
      document.getElementById('subM').focus();
    }

    async function saveSubNome() {
      if (!CAN_EDIT_SUB || !subCurrentAgId) return;

      const btn = document.getElementById('btnSaveSub');
      const csrf = getCSRFToken();

      const obj = {
        M: document.getElementById('subM').value,
        I: document.getElementById('subI').value,
        T: document.getElementById('subT').value,
        N: document.getElementById('subN').value,
      };

      const serialized = serializeSubstituto(obj);

      try {
        if (btn) { btn.disabled = true; btn.style.opacity = '0.7'; }

        const res = await fetch(`/admin/agendamento/${subCurrentAgId}/substituto`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf
          },
          body: JSON.stringify({ nome_substituto: serialized })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          const msg = data.error || `Erro ao salvar (${res.status}).`;
          alert(msg);
          return;
        }

        if (subCurrentEl) {
          subCurrentEl.setAttribute('data-sub-nome', serialized);
          renderSubLinesForEl(subCurrentEl);
          scheduleRefitAll();
        }

        alert("Substitutos atualizados com sucesso.");
        closeSubModal();
      } catch (err) {
        alert("Falha na conexão ao salvar substitutos.");
      } finally {
        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
      }
    }

    document.addEventListener('click', (e) => {
      const modal = document.getElementById('subModal');
      if (!modal || !modal.classList.contains('open')) return;
      if (e.target === modal) closeSubModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSubModal();
    });
    {% endif %}

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.agendamento').forEach(el => renderSubLinesForEl(el));
      scheduleRefitAll();

      // ✅ iOS/Android: resize ao scroll (barra de endereço). Só refaz se WIDTH mudar.
      let t = null;
      let lastW = window.innerWidth;

      window.addEventListener('resize', () => {
        const w = window.innerWidth;
        if (Math.abs(w - lastW) <= 2) return; // ignora resize “fake” por scroll
        lastW = w;

        clearTimeout(t);
        t = setTimeout(() => {
          __lastMobileColW = 0; // recalcula do zero quando realmente muda a largura (ex.: rotação)
          scheduleRefitAll();
        }, 160);
      }, { passive: true });

      window.addEventListener('load', () => {
        scheduleRefitAll();
      });
    });
  </script>
</body>
</html>
